<template><div><h1 id="inversify-源码分析" tabindex="-1"><a class="header-anchor" href="#inversify-源码分析"><span>inversify 源码分析</span></a></h1>
<p><img src="@source/AB产品知识库/images/知识探索/前端/inversify/inversify 源码分析/1.jpg" alt="inversify"></p>
<p>下图是 <strong>inversify@6.0.1</strong> 的源码结构：</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/inversify/inversify 源码分析/2.png" alt="inversify source construct"></p>
<p>inversify 有3个必须的阶段，以及2个可选阶段。</p>
<ul>
<li>Annotation</li>
<li>Planning</li>
<li>Resolution</li>
<li>Activation(optional)</li>
<li>Middleware(optional)</li>
</ul>
<p>整体5个阶段的执行顺序和关系如下图：</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/inversify/inversify 源码分析/3.png" alt="five phases"></p>
<h2 id="注解-annotation-实现" tabindex="-1"><a class="header-anchor" href="#注解-annotation-实现"><span>注解(Annotation)实现</span></a></h2>
<p>根据对 inversify 的使用发现，无论怎样所有的依赖都需要先使用<code v-pre>@injectable()</code>注解，然后绑定到容器中，才可以被注入，使用<code v-pre>@inejct()</code>，所以先从这两个注解出发，了解其中的实现原理。</p>
<p><strong>@injectable()</strong></p>
<p>从源码结构中可以清晰找到对应代码位置，在文件夹中通过文件名很容易定位到对应源码位置。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/annotation/injectable.ts</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token keyword">abstract</span></span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>Reflect<span class="token punctuation">.</span><span class="token function">hasOwnMetadata</span><span class="token punctuation">(</span><span class="token constant">METADATA_KEY</span><span class="token punctuation">.</span><span class="token constant">PARAM_TYPES</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERRORS_MSGS</span><span class="token punctuation">.</span><span class="token constant">DUPLICATED_INJECTABLE_DECORATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> types <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token constant">METADATA_KEY</span><span class="token punctuation">.</span><span class="token constant">DESIGN_PARAM_TYPES</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    Reflect<span class="token punctuation">.</span><span class="token function">defineMetadata</span><span class="token punctuation">(</span><span class="token constant">METADATA_KEY</span><span class="token punctuation">.</span><span class="token constant">PARAM_TYPES</span><span class="token punctuation">,</span> types<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> target<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>源码很简单，只有寥寥数行，<code v-pre>ETADATA_KEY.DESIGN_PARAM_TYPES</code>用于定义函数(依赖)的参数类型，然后在对应的目标依赖上绑定key为<code v-pre>METADATA_KEY.PARAM_TYPES</code>的元数据，并且不允许重复绑定，也就是一个<code v-pre>target</code>只允许使用一次<code v-pre>@injectable()</code>。根据之前的<code v-pre>reflect-metadata</code>可以知道，现在是将对应关系放在了一个<code v-pre>WeakMap</code>中。</p>
<p><strong>@inject()</strong></p>
<p>相对于<code v-pre>5.x</code>版本的 inversify 将<code v-pre>@inejct()</code>增加了<code v-pre>inject_base.ts</code>，由<code v-pre>inejct.ts</code>引用。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/annotation/inject.ts</span></span>
<span class="line"><span class="token keyword">const</span> inject <span class="token operator">=</span> <span class="token function">injectBase</span><span class="token punctuation">(</span><span class="token constant">METADATA_KEY</span><span class="token punctuation">.</span><span class="token constant">INJECT_TAG</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "inject"</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span> inject <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/annotation/inject_base.ts</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">injectBase</span><span class="token punctuation">(</span>metadataKey<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">(</span>serviceIdentifier<span class="token operator">:</span> ServiceIdentifierOrFunc<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">      target<span class="token operator">:</span> DecoratorTarget<span class="token punctuation">,</span></span>
<span class="line">      targetKey<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span></span>
<span class="line">      indexOrPropertyDescriptor<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> TypedPropertyDescriptor<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceIdentifier <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> className <span class="token operator">=</span> <span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">?</span> target<span class="token punctuation">.</span>name <span class="token operator">:</span> target<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">UNDEFINED_INJECT_ANNOTATION</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token function">createTaggedDecorator</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token keyword">new</span> <span class="token class-name">Metadata</span><span class="token punctuation">(</span>metadataKey<span class="token punctuation">,</span> serviceIdentifier<span class="token punctuation">)</span> <span class="token comment">// { key: metadataKey, value: serviceIdentifier }</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> targetKey<span class="token punctuation">,</span> indexOrPropertyDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>核心方法是<code v-pre>createTaggedDecorator()</code>，由于可以给属性可构造函数参数注入依赖，分别调用不同的处理函数，代码如下：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/annotation/decorator_utils.ts</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createTaggedDecorator</span><span class="token punctuation">(</span></span>
<span class="line">  metadata<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>MetadataOrMetadataArray<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">(</span></span>
<span class="line">    target<span class="token operator">:</span> DecoratorTarget<span class="token punctuation">,</span></span>
<span class="line">    targetKey<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span></span>
<span class="line">    indexOrPropertyDescriptor<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> TypedPropertyDescriptor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> indexOrPropertyDescriptor <span class="token operator">===</span> <span class="token string">"number"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">tagParameter</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> targetKey<span class="token punctuation">,</span> indexOrPropertyDescriptor<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">tagProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> targetKey <span class="token keyword">as</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在两个处理函数中，添加了不同的<code v-pre>METADATA_KEY</code>，格式化参数后又到了统一的处理函数中：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/annotation/decorator_utils.ts</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">tagParameter</span><span class="token punctuation">(</span></span>
<span class="line">  annotationTarget<span class="token operator">:</span> DecoratorTarget<span class="token punctuation">,</span></span>
<span class="line">  parameterName<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span></span>
<span class="line">  parameterIndex<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span></span>
<span class="line">  metadata<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>MetadataOrMetadataArray</span>
<span class="line"><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">_throwIfMethodParameter</span><span class="token punctuation">(</span>parameterName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// METADATA_KEY.TAGGED => "inversify:tagged"</span></span>
<span class="line">  <span class="token function">_tagParameterOrProperty</span><span class="token punctuation">(</span><span class="token constant">METADATA_KEY</span><span class="token punctuation">.</span><span class="token constant">TAGGED</span><span class="token punctuation">,</span> annotationTarget <span class="token keyword">as</span> ConstructorFunction<span class="token punctuation">,</span> parameterIndex<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">tagProperty</span><span class="token punctuation">(</span></span>
<span class="line">  annotationTarget<span class="token operator">:</span> DecoratorTarget<span class="token punctuation">,</span></span>
<span class="line">  propertyName<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span></span>
<span class="line">  metadata<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>MetadataOrMetadataArray</span>
<span class="line"><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">targetIsConstructorFunction</span><span class="token punctuation">(</span>annotationTarget<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR_MSGS</span><span class="token punctuation">.</span><span class="token constant">INVALID_DECORATOR_OPERATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// METADATA_KEY.TAGGED => "inversify:tagged_props"</span></span>
<span class="line">  <span class="token function">_tagParameterOrProperty</span><span class="token punctuation">(</span><span class="token constant">METADATA_KEY</span><span class="token punctuation">.</span><span class="token constant">TAGGED_PROP</span><span class="token punctuation">,</span> annotationTarget<span class="token punctuation">.</span>constructor<span class="token punctuation">,</span> propertyName<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于属性和构造函数参数有所不同，所以这里第2、3个参数也有所不同，分别传递第个参数以及属性名。</p>
<p><code v-pre>_tagParameterOrProperty</code>实现如下：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/annotation/decorator_utils.ts</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">_tagParameterOrProperty</span><span class="token punctuation">(</span></span>
<span class="line">  metadataKey<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">  annotationTarget<span class="token operator">:</span> NewableFunction<span class="token punctuation">,</span></span>
<span class="line">  key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span></span>
<span class="line">  metadata<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>MetadataOrMetadataArray<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> metadatas<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Metadata<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">_ensureNoMetadataKeyDuplicates</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">let</span> paramsOrPropertiesMetadata<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> interfaces<span class="token punctuation">.</span>Metadata<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// read metadata if available</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>Reflect<span class="token punctuation">.</span><span class="token function">hasOwnMetadata</span><span class="token punctuation">(</span>metadataKey<span class="token punctuation">,</span> annotationTarget<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    paramsOrPropertiesMetadata <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span>metadataKey<span class="token punctuation">,</span> annotationTarget<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">let</span> paramOrPropertyMetadata<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Metadata<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> paramsOrPropertiesMetadata<span class="token punctuation">[</span>key <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>paramOrPropertyMetadata <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    paramOrPropertyMetadata <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 无法重复定义相同key</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> m <span class="token keyword">of</span> paramOrPropertyMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>metadatas<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>md <span class="token operator">=></span> md<span class="token punctuation">.</span>key <span class="token operator">===</span> m<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">ERROR_MSGS</span><span class="token punctuation">.</span><span class="token constant">DUPLICATED_METADATA</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// set metadata</span></span>
<span class="line">  paramOrPropertyMetadata<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>metadatas<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  paramsOrPropertiesMetadata<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> paramOrPropertyMetadata<span class="token punctuation">;</span></span>
<span class="line">  Reflect<span class="token punctuation">.</span><span class="token function">defineMetadata</span><span class="token punctuation">(</span>metadataKey<span class="token punctuation">,</span> paramsOrPropertiesMetadata<span class="token punctuation">,</span> annotationTarget<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在定义元数据时，首先不能有重复的元数据(<code v-pre>metadata</code>)，然后先获取已有的元数据，然后将新定义的元数据加入。</p>
<h3 id="示例说明" tabindex="-1"><a class="header-anchor" href="#示例说明"><span>示例说明</span></a></h3>
<p>下面实际写一段代码，更好的理解上面的代码。假设现在我们需要一个“员工”，员工有一个“薪资”和“性别”属性，“薪资”是通过属性注入的，而“性别”是通过构造函数参数注入的，所以有如下代码。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Employee</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token decorator"><span class="token at operator">@</span><span class="token function">inject</span></span><span class="token punctuation">(</span><span class="token string">"Salary"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> salary<span class="token operator">:</span> Salary<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> gender<span class="token operator">:</span> Salary<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token decorator"><span class="token at operator">@</span><span class="token function">inject</span></span><span class="token punctuation">(</span><span class="token string">"Gender"</span><span class="token punctuation">)</span></span>
<span class="line">        gender<span class="token operator">:</span> Gender</span>
<span class="line">    <span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>gender <span class="token operator">=</span> gender<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"Work!"</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Salary</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"10000"</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Gender</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"男"</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先是<code v-pre>@injection()</code>，源码中<code v-pre>Reflect.defineMetadata(METADATA_KEY.PARAM_TYPES, types, target)</code>，实际上是这样：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line">Reflect<span class="token punctuation">.</span><span class="token function">defineMetadata</span><span class="token punctuation">(</span><span class="token string">"inversify:paramtypes"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">undefined</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Employee<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 因为在构造函数中使用了@inject()</span></span>
<span class="line">Reflect<span class="token punctuation">.</span><span class="token function">defineMetadata</span><span class="token punctuation">(</span><span class="token string">"inversify:paramtypes"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Salary<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">Reflect<span class="token punctuation">.</span><span class="token function">defineMetadata</span><span class="token punctuation">(</span><span class="token string">"inversify:paramtypes"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Gender<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后是<code v-pre>@inject()</code>，最终结果是这样的：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line">Reflect<span class="token punctuation">.</span><span class="token function">defineMetadata</span><span class="token punctuation">(</span><span class="token string">"inversify:tagged_props"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    salary<span class="token operator">:</span><span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            key<span class="token operator">:</span><span class="token string">"inject"</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">"Salary"</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> Employee<span class="token punctuation">)</span>  </span>
<span class="line">Reflect<span class="token punctuation">.</span><span class="token function">defineMetadata</span><span class="token punctuation">(</span><span class="token string">"inversify:tagged"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">"0"</span><span class="token operator">:</span><span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            key<span class="token operator">:</span><span class="token string">"inject"</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">"Gender"</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> Employee<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>效果就好像在<code v-pre>Employee</code>上绑定了两个种类型的元数据，如下图：</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/inversify/inversify 源码分析/4.png" alt="inject tagged"></p>
<h2 id="绑定依赖" tabindex="-1"><a class="header-anchor" href="#绑定依赖"><span>绑定依赖</span></a></h2>
<p>当前如果要<code v-pre>@inejct()</code>生效的话，还需要将需要注入的依赖绑定到容器中，因为只有绑定到容器中的依赖才可以被注入。</p>
<p>接着上面的实例代码，我们就使用基本的绑定方法：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">let</span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">container</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"Salary"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>Salary<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">container</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"Gender"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>Gender<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">container</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"Employee"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>Employee<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>注意这里<code v-pre>bind(&quot;Salary&quot;).to(Salary)</code>和<code v-pre>bind(Salary).to(Salary)</code>是不同的，并且写法都是合法的。</p>
</blockquote>
<p><code v-pre>.bind()</code>方法会返回一个<code v-pre>BindingToSyntax</code>类型的数据，表示：<em>绑定<code v-pre>to</code>语法</em>，用于提供后续api，比如：<code v-pre>.to()</code>、<code v-pre>.toSelf()</code>和<code v-pre>.toDynamicValue()</code>等。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/container/container.ts</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token generic-function"><span class="token function">bind</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>serviceIdentifier<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>ServiceIdentifier<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>BindingToSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>defaultScope <span class="token operator">||</span> BindingScopeEnum<span class="token punctuation">.</span>Transient<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> binding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span>serviceIdentifier<span class="token punctuation">,</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 将所有的依赖全部保存到一个Map中</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>_bindingDictionary<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>serviceIdentifier<span class="token punctuation">,</span> binding <span class="token keyword">as</span> Binding<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BindingToSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span>binding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p><code v-pre>_bindingDictionary</code>中封装了一个Map以及相关操作，源码位置在：<code v-pre>/src/container/lookup.ts</code>。</p>
</blockquote>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/syntax/binding_to_syntax.ts</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">BindingToSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span> <span class="token keyword">implements</span> <span class="token class-name">interfaces</span><span class="token punctuation">.</span>BindingToSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> _binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">constructor</span><span class="token punctuation">(</span>binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_binding <span class="token operator">=</span> binding<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">to</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BindingInWhenOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">toSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">.</span>serviceIdentifier<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">toConstantValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BindingWhenOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">toDynamicValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BindingInWhenOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在调用<code v-pre>.toXX()</code>方法后，返回的实例从名字可以看出后续支持的api类型，如：<code v-pre>BindingInWhenOnSyntax</code>就是可以使用<code v-pre>.in</code>、<code v-pre>.when</code>和<code v-pre>.on</code>相关api，比较熟悉的有：<code v-pre>.inSingletonScope()</code>、<code v-pre>.whenTargetTagged()</code>、<code v-pre>.whenTargetNamed()</code>和<code v-pre>.onActivation()</code>。</p>
<p>inversify 支持链式调用，也就是在调用一个方法后仍然可以继续调用其他API，这些都是在代码里面约束的。比如在<code v-pre>.whenTargetTagged()</code>后还可以调用<code v-pre>.onXX()</code>，代码如下：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/syntax/binding_when_syntax.ts</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">BindingWhenSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span> <span class="token keyword">implements</span> <span class="token class-name">interfaces</span><span class="token punctuation">.</span>BindingWhenSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> _binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">constructor</span><span class="token punctuation">(</span>binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_binding <span class="token operator">=</span> binding<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">whenTargetNamed</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>BindingOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">.</span>constraint <span class="token operator">=</span> <span class="token function">namedConstraint</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BindingOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">whenTargetTagged</span><span class="token punctuation">(</span>tag<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>BindingOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">.</span>constraint <span class="token operator">=</span> <span class="token function">taggedConstraint</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BindingOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p><code v-pre>.whenTargetTagged()</code>可能既包含在<code v-pre>BindingWhenOnSyntax</code>中，也包含的<code v-pre>BindingInWhenOnSyntax</code>中。</p>
</blockquote>
<h3 id="绑定语法对应的api" tabindex="-1"><a class="header-anchor" href="#绑定语法对应的api"><span>绑定语法对应的API</span></a></h3>
<table>
<thead>
<tr>
<th>to</th>
<th>in</th>
<th>on</th>
<th>when</th>
</tr>
</thead>
<tbody>
<tr>
<td>.to()</td>
<td>.inRequestScope()</td>
<td>.onActivation()</td>
<td>.when()</td>
</tr>
<tr>
<td>.toSelf()</td>
<td>.inSingletonScope()</td>
<td>.onDeactivation()</td>
<td>.whenTargetNamed()</td>
</tr>
<tr>
<td>.toConstantValue()</td>
<td>.inTransientScope()</td>
<td></td>
<td>.whenTargetIsDefault()</td>
</tr>
<tr>
<td>.toDynamicValue()</td>
<td></td>
<td></td>
<td>.whenTargetTagged()</td>
</tr>
<tr>
<td>.toConstructor()</td>
<td></td>
<td></td>
<td>.whenInjectedInto()</td>
</tr>
<tr>
<td>.toFactory()</td>
<td></td>
<td></td>
<td>.whenParentNamed()</td>
</tr>
<tr>
<td>.toFunction()</td>
<td></td>
<td></td>
<td>.whenParentTagged()</td>
</tr>
<tr>
<td>.toAutoFactory()</td>
<td></td>
<td></td>
<td>.whenAnyAncestorIs()</td>
</tr>
<tr>
<td>.toAutoNamedFactory()</td>
<td></td>
<td></td>
<td>.whenNoAncestorIs()</td>
</tr>
<tr>
<td>.toProvider()</td>
<td></td>
<td></td>
<td>.whenAnyAncestorNamed()</td>
</tr>
<tr>
<td>.toService()</td>
<td></td>
<td></td>
<td>.whenNoAncestorNamed()</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>.whenAnyAncestorTagged()</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>.whenNoAncestorTagged()</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>.whenAnyAncestorMatches()</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>.whenNoAncestorMatches()</td>
</tr>
</tbody>
</table>
<h3 id="重复绑定" tabindex="-1"><a class="header-anchor" href="#重复绑定"><span>重复绑定</span></a></h3>
<p>根据链式调用的规则，由源码中各个语法间可以互相调用的关系，可以得到如下的关系：</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/inversify/inversify 源码分析/5.png" alt="binding syntax"></p>
<p>很容易发现存在一些“圈”，也就是可以循环调用。那么基于上面的实例，可以写出如下代码：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token function">container</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>Employee<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onActivation</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> firstEmployee<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Employee first activation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> firstEmployee<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenTargetNamed</span><span class="token punctuation">(</span><span class="token string">"Employee1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onActivation</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> secondEmployee<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Employee second activation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> secondEmployee<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenTargetNamed</span><span class="token punctuation">(</span><span class="token string">"Employee2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后我们尝试获取<code v-pre>Employee</code>：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line">contarin<span class="token punctuation">.</span><span class="token function">getNamed</span><span class="token punctuation">(</span><span class="token string">"Employee2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">contarin<span class="token punctuation">.</span><span class="token function">getNamed</span><span class="token punctuation">(</span><span class="token string">"Employee1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>结果如下：</p>
<div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre v-pre><code><span class="line">Employee second activation</span>
<span class="line"></span>
<span class="line">Error: No matching bindings found for serviceIdentifier: Employee</span>
<span class="line"> Employee - named: Employee1</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从结果可以发现，在重复绑定的过程中，<strong>相同语法的api后面的会覆盖前面的</strong>。</p>
<blockquote>
<p>注意：<strong>相同语法</strong>，也就是<code v-pre>.whenTargetNamed()</code>和<code v-pre>.whenTargetTagged()</code>都属于<code v-pre>when</code>语法，只有后调用的会生效。</p>
</blockquote>
<p>对应代码的实现，是因为全程都是操作的同一个<code v-pre>Binding</code>实例，这个实例在<code v-pre>bind</code>源码中被实例化，并且被后续所有的绑定语法所使用，可以从上文的<code v-pre>class BindingToSyntax</code>、<code v-pre>public bind</code>和<code v-pre>class BindingWhenSyntax</code>源码中找到。下面只摘取部分关键代码：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/container/container.ts</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token generic-function"><span class="token function">bind</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>serviceIdentifier<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>ServiceIdentifier<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>BindingToSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> binding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span>serviceIdentifier<span class="token punctuation">,</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BindingToSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span>binding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// src/syntax/binding_to_syntax.ts</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">BindingToSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span> <span class="token keyword">implements</span> <span class="token class-name">interfaces</span><span class="token punctuation">.</span>BindingToSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> _binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">constructor</span><span class="token punctuation">(</span>binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_binding <span class="token operator">=</span> binding<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">to</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BindingInWhenOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 内部直接调用 BindingWhenSyntax 中方法</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// src/syntax/binding_when_syntax.ts</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">BindingWhenSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span> <span class="token keyword">implements</span> <span class="token class-name">interfaces</span><span class="token punctuation">.</span>BindingWhenSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> _binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">constructor</span><span class="token punctuation">(</span>binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_binding <span class="token operator">=</span> binding<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">whenTargetNamed</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>BindingOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">.</span>constraint <span class="token operator">=</span> <span class="token function">namedConstraint</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BindingOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">whenTargetTagged</span><span class="token punctuation">(</span>tag<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>BindingOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">.</span>constraint <span class="token operator">=</span> <span class="token function">taggedConstraint</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BindingOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="获取依赖" tabindex="-1"><a class="header-anchor" href="#获取依赖"><span>获取依赖</span></a></h2>
<p>最后一步就是获取依赖了，因为之后这一步完成了之后，我们才能真正的拿到对应的实例，才能去进行操作，之前的操作都是为了这一步做铺垫。</p>
<p>在代码实现上，这里需要经历<code v-pre>计划(planning)</code>和<code v-pre>解析(resolution)</code>两个阶段，这里我们从<code v-pre>.get()</code>入手，看一下是如何获取对应实例的。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/container/container.ts</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token generic-function"><span class="token function">_get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>getArgs<span class="token operator">:</span> GetArgs<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>ContainerResolution<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> planAndResolveArgs<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>NextArgs<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token operator">...</span>getArgs<span class="token punctuation">,</span> <span class="token comment">// 其中包含着依赖的唯一id，这里叫做：serviceIdentifier</span></span>
<span class="line">        <span class="token function-variable function">contextInterceptor</span><span class="token operator">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">=></span> context<span class="token punctuation">,</span></span>
<span class="line">        targetType<span class="token operator">:</span> TargetTypeEnum<span class="token punctuation">.</span>Variable</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">_planAndResolve</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>planAndResolveArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code v-pre>_planAndResolve</code>中先创建了一个计划，解析器将计划解析成对应的依赖并且返回。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/container/container.ts</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token generic-function"><span class="token function">_planAndResolve</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span>args<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>NextArgs<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> interfaces<span class="token punctuation">.</span>ContainerResolution<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span>args<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>NextArgs<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// create a plan</span></span>
<span class="line">        <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token function">plan</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_metadataReader<span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">,</span></span>
<span class="line">            args<span class="token punctuation">.</span>isMultiInject<span class="token punctuation">,</span></span>
<span class="line">            args<span class="token punctuation">.</span>targetType<span class="token punctuation">,</span></span>
<span class="line">            args<span class="token punctuation">.</span>serviceIdentifier<span class="token punctuation">,</span></span>
<span class="line">            args<span class="token punctuation">.</span>key<span class="token punctuation">,</span></span>
<span class="line">            args<span class="token punctuation">.</span>value<span class="token punctuation">,</span></span>
<span class="line">            args<span class="token punctuation">.</span>avoidConstraints</span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        <span class="token comment">// resolve plan</span></span>
<span class="line">        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token generic-function"><span class="token function">resolve</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="计划阶段-planning" tabindex="-1"><a class="header-anchor" href="#计划阶段-planning"><span>计划阶段(Planning)</span></a></h3>
<p>计划阶段中使用了<code v-pre>_metadataReader</code>，这个实例中的方法用于读取在依赖上绑定的元数据，也就是之前写的<code v-pre>@injectable()</code>和<code v-pre>@inject()</code>绑定的元数据，代码如下：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/planning/metadata_reader.ts</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MetadataReader</span> <span class="token keyword">implements</span> <span class="token class-name">interfaces</span><span class="token punctuation">.</span>MetadataReader <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">public</span> <span class="token function">getConstructorMetadata</span><span class="token punctuation">(</span>constructorFunc<span class="token operator">:</span> NewableFunction<span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>ConstructorMetadata <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// TypeScript compiler generated annotations</span></span>
<span class="line">    <span class="token keyword">const</span> compilerGeneratedMetadata <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token constant">METADATA_KEY</span><span class="token punctuation">.</span><span class="token constant">PARAM_TYPES</span><span class="token punctuation">,</span> constructorFunc<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// User generated constructor annotations</span></span>
<span class="line">    <span class="token keyword">const</span> userGeneratedMetadata <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token constant">METADATA_KEY</span><span class="token punctuation">.</span><span class="token constant">TAGGED</span><span class="token punctuation">,</span> constructorFunc<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">      compilerGeneratedMetadata<span class="token punctuation">,</span></span>
<span class="line">      userGeneratedMetadata<span class="token operator">:</span> userGeneratedMetadata <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">public</span> <span class="token function">getPropertiesMetadata</span><span class="token punctuation">(</span>constructorFunc<span class="token operator">:</span> NewableFunction<span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>MetadataMap <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// User generated properties annotations</span></span>
<span class="line">    <span class="token keyword">const</span> userGeneratedMetadata <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token constant">METADATA_KEY</span><span class="token punctuation">.</span><span class="token constant">TAGGED_PROP</span><span class="token punctuation">,</span> constructorFunc<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> userGeneratedMetadata<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每获取一个依赖，都需要创建一个<code v-pre>plan</code>，其中会创建一个<code v-pre>Request</code>，有一个<code v-pre>rootRequest</code>，如果遇到内部有其他依赖，会继续创建<code v-pre>childRequest</code>去解析内部的依赖。由此应该可以更好的理解<code v-pre>request</code>作用域的概念。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/planning/planner.ts</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">plan</span><span class="token punctuation">(</span></span>
<span class="line">  metadataReader<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>MetadataReader<span class="token punctuation">,</span></span>
<span class="line">  container<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Container<span class="token punctuation">,</span></span>
<span class="line">  isMultiInject<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span></span>
<span class="line">  targetType<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>TargetType<span class="token punctuation">,</span></span>
<span class="line">  serviceIdentifier<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>ServiceIdentifier<span class="token punctuation">,</span></span>
<span class="line">  key<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span></span>
<span class="line">  value<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span></span>
<span class="line">  avoidConstraints <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Context <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">    <span class="token function">_createSubRequests</span><span class="token punctuation">(</span>metadataReader<span class="token punctuation">,</span> avoidConstraints<span class="token punctuation">,</span> serviceIdentifier<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> context<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/planning/planner.ts</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">_createSubRequests</span><span class="token punctuation">(</span></span>
<span class="line">  metadataReader<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>MetadataReader<span class="token punctuation">,</span></span>
<span class="line">  avoidConstraints<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span></span>
<span class="line">  serviceIdentifier<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>ServiceIdentifier<span class="token punctuation">,</span></span>
<span class="line">  context<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Context<span class="token punctuation">,</span></span>
<span class="line">  parentRequest<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Request <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  target<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Target</span>
<span class="line"><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentRequest <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        activeBindings <span class="token operator">=</span> <span class="token function">_getActiveBindings</span><span class="token punctuation">(</span>metadataReader<span class="token punctuation">,</span> avoidConstraints<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        childRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span></span>
<span class="line">            serviceIdentifier<span class="token punctuation">,</span></span>
<span class="line">            context<span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 这里null表示根Request</span></span>
<span class="line">            activeBindings<span class="token punctuation">,</span></span>
<span class="line">            target</span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">const</span> thePlan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Plan</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> childRequest<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        context<span class="token punctuation">.</span><span class="token function">addPlan</span><span class="token punctuation">(</span>thePlan<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        activeBindings <span class="token operator">=</span> <span class="token function">_getActiveBindings</span><span class="token punctuation">(</span>metadataReader<span class="token punctuation">,</span> avoidConstraints<span class="token punctuation">,</span> context<span class="token punctuation">,</span> parentRequest<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        childRequest <span class="token operator">=</span> parentRequest<span class="token punctuation">.</span><span class="token function">addChildRequest</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>serviceIdentifier<span class="token punctuation">,</span> activeBindings<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    activeBindings<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>binding<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">let</span> subChildRequest<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Request <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            subChildRequest <span class="token operator">=</span> childRequest<span class="token punctuation">.</span><span class="token function">addChildRequest</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>serviceIdentifier<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>binding<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            subChildRequest <span class="token operator">=</span> childRequest<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>binding<span class="token punctuation">.</span>type <span class="token operator">===</span> BindingTypeEnum<span class="token punctuation">.</span>Instance <span class="token operator">&amp;&amp;</span> binding<span class="token punctuation">.</span>implementationType <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 这里会解析到内部依赖，如：Salary 和 Gender</span></span>
<span class="line">            <span class="token keyword">const</span> dependencies <span class="token operator">=</span> <span class="token function">getDependencies</span><span class="token punctuation">(</span>metadataReader<span class="token punctuation">,</span> binding<span class="token punctuation">.</span>implementationType<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// ...</span></span>
<span class="line">            dependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dependency<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Target<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">_createSubRequests</span><span class="token punctuation">(</span>metadataReader<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> dependency<span class="token punctuation">.</span>serviceIdentifier<span class="token punctuation">,</span> context<span class="token punctuation">,</span> subChildRequest<span class="token punctuation">,</span> dependency<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>整个解析过程和最终的结构大致如下：</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/inversify/inversify 源码分析/6.png" alt="planning"></p>
<h3 id="解析阶段-resolution" tabindex="-1"><a class="header-anchor" href="#解析阶段-resolution"><span>解析阶段(Resolution)</span></a></h3>
<p>上面的<code v-pre>planning</code>完成后，就到了<code v-pre>resolution</code>，解析阶段拿到计划阶段的结果，调用<code v-pre>resolve()</code>进行解析。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/resolution/resolver.ts</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">resolve</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>context<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> _f <span class="token operator">=</span> <span class="token generic-function"><span class="token function">_resolveRequest</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>plan<span class="token punctuation">.</span>rootRequest<span class="token punctuation">.</span>requestScope <span class="token keyword">as</span> interfaces<span class="token punctuation">.</span>RequestScope<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">_f</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>plan<span class="token punctuation">.</span>rootRequest<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在解析逻辑中，会判断当前依赖绑定的类型（如：<code v-pre>.toConstantValue()</code>和<code v-pre>.toConstructor()</code>）进行不同的返回：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/resolution/resolver.ts</span></span>
<span class="line"><span class="token keyword">const</span> _getResolvedFromBinding <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">(</span></span>
<span class="line">  requestScope<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>RequestScope<span class="token punctuation">,</span></span>
<span class="line">  request<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Request<span class="token punctuation">,</span></span>
<span class="line">  binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> result<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> childRequests <span class="token operator">=</span> request<span class="token punctuation">.</span>childRequests<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line">  <span class="token keyword">switch</span> <span class="token punctuation">(</span>binding<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> BindingTypeEnum<span class="token punctuation">.</span>ConstantValue<span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">case</span> BindingTypeEnum<span class="token punctuation">.</span><span class="token builtin">Function</span><span class="token operator">:</span></span>
<span class="line">      result <span class="token operator">=</span> binding<span class="token punctuation">.</span>cache <span class="token keyword">as</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">case</span> BindingTypeEnum<span class="token punctuation">.</span>Constructor<span class="token operator">:</span></span>
<span class="line">      result <span class="token operator">=</span> binding<span class="token punctuation">.</span>implementationType <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">case</span> BindingTypeEnum<span class="token punctuation">.</span>Instance<span class="token operator">:</span></span>
<span class="line">      result <span class="token operator">=</span> <span class="token generic-function"><span class="token function">resolveInstance</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span></span>
<span class="line">        binding<span class="token punctuation">,</span></span>
<span class="line">        binding<span class="token punctuation">.</span>implementationType <span class="token keyword">as</span> interfaces<span class="token punctuation">.</span>Newable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span></span>
<span class="line">        childRequests<span class="token punctuation">,</span></span>
<span class="line">        <span class="token generic-function"><span class="token function">_resolveRequest</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>requestScope<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">      result <span class="token operator">=</span> <span class="token function">_resolveFactoryFromBinding</span><span class="token punctuation">(</span>binding<span class="token punctuation">,</span> request<span class="token punctuation">.</span>parentContext<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> result <span class="token keyword">as</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>postCoustruct</strong></p>
<p>之前提到的<code v-pre>@postCoustruct()</code>对应的方法就是在<code v-pre>resolveInstance()</code>被调用的，是在解析阶段返回具体的实例前被调用。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/resolution/instantiations.ts</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">resolveInstance</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span></span>
<span class="line">  binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span></span>
<span class="line">  constr<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Newable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span></span>
<span class="line">  childRequests<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Request<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  resolveRequest<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>ResolveRequestHandler<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line">  <span class="token comment">// 这里的 result 是具体的到的实例</span></span>
<span class="line">  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">_createInstance</span><span class="token punctuation">(</span>constr<span class="token punctuation">,</span> childRequests<span class="token punctuation">,</span> resolveRequest<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 在 _getInstanceAfterPostConstruct 方法中调用 @postCoustruct() 绑定方法后返回 result</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolvedResult<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">_getInstanceAfterPostConstruct</span><span class="token punctuation">(</span>constr<span class="token punctuation">,</span> resolvedResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">_getInstanceAfterPostConstruct</span><span class="token punctuation">(</span>constr<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p><code v-pre>_getInstanceAfterPostConstruct</code>代码实现比较简单，可以自行查看，也在<code v-pre>src/resolution/instantiations.ts</code>文件中。</p>
</blockquote>
<p><strong>依赖注入</strong></p>
<p>最后需要关注的就是，inversify 是如何将依赖注入到对应实例和参数上的，具体实现就在<code v-pre>_createInstance()</code>方法中。在内部有分为两步：</p>
<ol>
<li>通过<code v-pre>childRequests</code>将所有依赖实例化，并保存在不同注入类型（属性和参数）的数组中。</li>
<li>根据不同的类型，将对应的依赖通过不同的方法注入到实例中。</li>
</ol>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/resolution/instantiations.ts</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">_createInstance</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span></span>
<span class="line">  constr<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Newable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span></span>
<span class="line">  childRequests<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Request<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  resolveRequest<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>ResolveRequestHandler<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> result<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 获取依赖</span></span>
<span class="line">    <span class="token keyword">const</span> resolved <span class="token operator">=</span> <span class="token function">_resolveRequests</span><span class="token punctuation">(</span>childRequests<span class="token punctuation">,</span> resolveRequest<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> createInstanceWithInjectionsArg<span class="token operator">:</span> CreateInstanceWithInjectionArg<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>resolved<span class="token punctuation">,</span> constr <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">    <span class="token comment">// 依赖注入</span></span>
<span class="line">    result <span class="token operator">=</span> <span class="token function">createInstanceWithInjections</span><span class="token punctuation">(</span>createInstanceWithInjectionsArg<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/resolution/instantiations.ts</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">_resolveRequests</span><span class="token punctuation">(</span></span>
<span class="line">  childRequests<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Request<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  resolveRequest<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>ResolveRequestHandler</span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> ResolvedRequests <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> childRequests<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">reduce</span><span class="token generic class-name"><span class="token operator">&lt;</span>ResolvedRequests<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolvedRequests<span class="token punctuation">,</span> childRequest<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> injection <span class="token operator">=</span> <span class="token function">resolveRequest</span><span class="token punctuation">(</span>childRequest<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> targetType <span class="token operator">=</span> childRequest<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token keyword">type</span></span>
<span class="line">    <span class="token class-name"><span class="token keyword">if</span></span> <span class="token punctuation">(</span>targetType <span class="token operator">===</span> TargetTypeEnum<span class="token punctuation">.</span>ConstructorArgument<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      resolvedRequests<span class="token punctuation">.</span>constructorInjections<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>injection<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      resolvedRequests<span class="token punctuation">.</span>propertyRequests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>childRequest<span class="token punctuation">)</span></span>
<span class="line">      resolvedRequests<span class="token punctuation">.</span>propertyInjections<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>injection<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolvedRequests<span class="token punctuation">.</span>isAsync<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      resolvedRequests<span class="token punctuation">.</span>isAsync <span class="token operator">=</span> <span class="token function">isPromiseOrContainsPromise</span><span class="token punctuation">(</span>injection<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> resolvedRequests</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> constructorInjections<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> propertyInjections<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> propertyRequests<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> isAsync<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/resolution/instantiations.ts</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">createInstanceWithInjections</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span></span>
<span class="line">  args<span class="token operator">:</span> CreateInstanceWithInjectionArg<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">args</span><span class="token punctuation">.</span><span class="token function">constr</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span>constructorInjections <span class="token keyword">as</span> <span class="token builtin">never</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  args<span class="token punctuation">.</span>propertyRequests<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> index<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> property <span class="token operator">=</span> r<span class="token punctuation">.</span>target<span class="token punctuation">.</span>identifier<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> injection <span class="token operator">=</span> args<span class="token punctuation">.</span>propertyInjections<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">(</span>instance <span class="token keyword">as</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">[</span>property<span class="token punctuation">]</span> <span class="token operator">=</span> injection<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> instance</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>整个流程图大致如下：</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/inversify/inversify 源码分析/7.png" alt="resolution"></p>
<blockquote>
<p>在<code v-pre>5.x</code>版本中，实现的方式略有不同，部分代码如下：
<img src="@source/AB产品知识库/images/知识探索/前端/inversify/inversify 源码分析/8.png" alt="create instance in 5.x"></p>
</blockquote>
<h2 id="中间件-middleware" tabindex="-1"><a class="header-anchor" href="#中间件-middleware"><span>中间件(Middleware)</span></a></h2>
<p>官方文档对中间件描述如下：</p>
<blockquote>
<p>If we have configured some Middleware it will be executed at some point before or after the planning, resolution and activation phases. —— <a href="https://github.com/inversify/InversifyJS/blob/715a3f996e69d85b24487dd74758cb79fb5c5273/wiki/middleware.md#middleware" target="_blank" rel="noopener noreferrer">Middleware</a></p>
</blockquote>
<p>中间件可以在这3个阶段的前后做一些事情，这里的3个阶段是一个整体，不能在中间调用中间件，也就是如果原本流程是<code v-pre>A -&gt; B</code>，那么中间件的逻辑只能添加到<code v-pre>A</code>前或者<code v-pre>B</code>后，如：<code v-pre>middleware -&gt; A -&gt; B </code>和<code v-pre>A -&gt; B -&gt; middleware</code>，但<code v-pre>A -&gt; middleware -&gt; B</code>是不行的。</p>
<p>使用<code v-pre>applyMiddleware()</code>方法注册中间件，注册和使用代码如下：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/container/container.ts</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewares<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Middleware<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> initial<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Next <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_middleware<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_middleware <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_planAndResolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>_middleware <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span></span>
<span class="line">      <span class="token punctuation">(</span>prev<span class="token punctuation">,</span> curr<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">curr</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      initial<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token generic-function"><span class="token function">_get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>getArgs<span class="token operator">:</span> GetArgs<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>ContainerResolution<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> middlewareResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_middleware</span><span class="token punctuation">(</span>planAndResolveArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        <span class="token keyword">return</span> middlewareResult<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">_planAndResolve</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>planAndResolveArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="activation" tabindex="-1"><a class="header-anchor" href="#activation"><span>Activation</span></a></h2>
<p>会在解析阶段被执行（参考开头的各个阶段的关系图），代码如下：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/resoluton/resolver.ts</span></span>
<span class="line"><span class="token keyword">const</span> _bindingActivation <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">(</span>context<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span> previousResult<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> result<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// use activation handler if available</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> binding<span class="token punctuation">.</span>onActivation <span class="token operator">===</span> <span class="token string">"function"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    result <span class="token operator">=</span> binding<span class="token punctuation">.</span><span class="token function">onActivation</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> previousResult<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    result <span class="token operator">=</span> previousResult<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>onActivation</code>来自于前面提到过的<code v-pre>.onActivation()</code>方法：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/syntax/binding_on_syntax.tx</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">BindingOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span> <span class="token keyword">implements</span> <span class="token class-name">interfaces</span><span class="token punctuation">.</span>BindingOnSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">private</span> _binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">public</span> <span class="token function">constructor</span><span class="token punctuation">(</span>binding<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Binding<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>_binding <span class="token operator">=</span> binding<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">public</span> <span class="token function">onActivation</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>BindingActivation<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>BindingWhenSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">.</span>onActivation <span class="token operator">=</span> handler<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BindingWhenSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">public</span> <span class="token function">onDeactivation</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>BindingDeactivation<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>BindingWhenSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">.</span>onDeactivation <span class="token operator">=</span> handler<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BindingWhenSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_binding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="其他" tabindex="-1"><a class="header-anchor" href="#其他"><span>其他</span></a></h2>
<h3 id="context" tabindex="-1"><a class="header-anchor" href="#context"><span>Context</span></a></h3>
<p>在使用和源码中发现有的地方使用了<code v-pre>context</code>，下面是具体的代码实现，其中可以获取到当前的容器实例、plan实例和当前正在进行的request，可以让我们注册的回调函数中进行更多样和灵活的操作。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/planning/context.ts</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token keyword">implements</span> <span class="token class-name">interfaces</span><span class="token punctuation">.</span>Context <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">public</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">public</span> container<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Container<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">public</span> plan<span class="token operator">!</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Plan<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">public</span> currentRequest<span class="token operator">!</span><span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Request<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">public</span> <span class="token function">constructor</span><span class="token punctuation">(</span></span>
<span class="line">    container<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Container<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> container<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">public</span> <span class="token function">addPlan</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Plan<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>plan <span class="token operator">=</span> plan<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">public</span> <span class="token function">setCurrentRequest</span><span class="token punctuation">(</span>currentRequest<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>currentRequest <span class="token operator">=</span> currentRequest<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="作用域" tabindex="-1"><a class="header-anchor" href="#作用域"><span>作用域</span></a></h3>
<h3 id="toservice" tabindex="-1"><a class="header-anchor" href="#toservice"><span>toService</span></a></h3>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// src/syntax/binding_to_syntax.ts</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">BindingToSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span> <span class="token keyword">implements</span> <span class="token class-name">interfaces</span><span class="token punctuation">.</span>BindingToSyntax<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">toService</span><span class="token punctuation">(</span>service<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span> <span class="token operator">|</span> interfaces<span class="token punctuation">.</span>Newable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token operator">|</span> interfaces<span class="token punctuation">.</span>Abstract<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toDynamicValue</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">=></span> context<span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>service<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="小结" tabindex="-1"><a class="header-anchor" href="#小结"><span>小结</span></a></h2>
<p>inversify 有5个阶段，其中3个必须和2个可选，介绍了其中运行情况和包含关系。由一个小例子开始，引出<code v-pre>Annotation</code>的实现，接着是<code v-pre>Planning</code>和<code v-pre>Resolution</code>，从源码的角度解释了整个 inversify 流程的实现。后面对2个可选阶段，<code v-pre>Middleware</code>和<code v-pre>Activation</code>的源码也进行了分析。当然，这并不是一个100%的源码分析，看完这些应该对后续阅读源码有所帮助，对 inversify 的实现有个大概的认识，在更深入的学习过程中针对不同的细节，可以再详细学习。</p>
</div></template>



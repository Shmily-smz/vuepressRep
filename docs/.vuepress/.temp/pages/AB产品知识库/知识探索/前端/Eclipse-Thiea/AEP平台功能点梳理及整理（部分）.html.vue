<template><div><blockquote>
<p>最新代码可能有所更新，如有差异可查看<a href="http://192.9.200.187/aep" target="_blank" rel="noopener noreferrer">最新代码</a>。</p>
</blockquote>
<h2 id="_1-启动流程" tabindex="-1"><a class="header-anchor" href="#_1-启动流程"><span>1.启动流程</span></a></h2>
<p>通过<code v-pre>npm run dev</code>命令通过<code v-pre>gulpfile.js</code>启动开发模式，大概流程如下。</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/Eclipse-Thiea/AEP平台功能点梳理及整理（部分）/1.png" alt="startup-process"></p>
<p>其中除了清理工作空间及监听文件变动任务外，核心的两个任务如下：</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token comment">// main process 的编译</span></span>
<span class="line">gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">"babel:electron-main"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  	<span class="token keyword">return</span> gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token constant">APP_PATH</span> <span class="token operator">+</span> <span class="token string">'/src/**/*.js'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">babel</span><span class="token punctuation">(</span>babelSetting<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token constant">DEST_PATH</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//开发模式启动electron</span></span>
<span class="line">gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">"electron:start"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  	<span class="token function">greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  	<span class="token function">startElectron</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  	gulp<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token constant">APP_PATH</span> <span class="token operator">+</span> <span class="token string">'/src/**/*.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> gulp<span class="token punctuation">.</span><span class="token function">series</span><span class="token punctuation">(</span><span class="token string">"babel:electron-main"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  	gulp<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token constant">APP_PATH</span> <span class="token operator">+</span> <span class="token string">'/dist/electron/**/*.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">   		<span class="token keyword">if</span> <span class="token punctuation">(</span>electronProcess <span class="token operator">&amp;&amp;</span> electronProcess<span class="token punctuation">.</span>kill<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      		manualRestart <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">      		process<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span>electronProcess<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      		electronProcess <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">      		<span class="token function">startElectron</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      		<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">        			manualRestart <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">      		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">  	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中<code v-pre>babel:electron-main</code>任务通过babel将<code v-pre>src</code>目录下的代码进行编译并输出到目标位置，<code v-pre>src</code>下文件主要是启动electron的主进程入口文件及相关配置文件。<code v-pre>electron:start</code>任务通过编译好的入口文件在<code v-pre>startElectron</code>方法中启动electron客户端。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">startElectron</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  	<span class="token keyword">const</span> entryJs <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token constant">DEST_PATH</span><span class="token punctuation">,</span> <span class="token string">'./main.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  	<span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    		<span class="token string">'--inspect=5858'</span><span class="token punctuation">,</span></span>
<span class="line">    		entryJs</span>
<span class="line">  	<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  	electronProcess <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>electron<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  	<span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-启动细节" tabindex="-1"><a class="header-anchor" href="#_2-启动细节"><span>2.启动细节</span></a></h2>
<p>主进程的入口文件关键代码如下：</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token keyword">async</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 初始化配置</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 初始化环境路径</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initEnvironmentPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 初始化应用</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'[initApp]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> scheduleOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  scheduleOptions<span class="token punctuation">.</span>isDev <span class="token operator">=</span> isDev<span class="token punctuation">;</span></span>
<span class="line">  scheduleOptions<span class="token punctuation">.</span>appHome <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  scheduleOptions<span class="token punctuation">.</span>exePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token string">'exe'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  scheduleOptions<span class="token punctuation">.</span>pluginDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>scheduleOptions<span class="token punctuation">.</span>appHome<span class="token punctuation">,</span> <span class="token string">'../node_modules/@aep-plugins/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    	<span class="token keyword">if</span> <span class="token punctuation">(</span>isDev<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">     		<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">installDevtoolAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    	<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    	<span class="token keyword">await</span> splashWindow<span class="token punctuation">.</span><span class="token function">showAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    	<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeStartupTask</span><span class="token punctuation">(</span>scheduleOptions<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    	splashWindow<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line">  app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"window-all-closed"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    	<span class="token keyword">await</span> splashWindow<span class="token punctuation">.</span><span class="token function">showAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    	<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeEndTasks</span><span class="token punctuation">(</span>scheduleOptions<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    	app<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面我们一行一行来看下在启动过程中都做了哪些事？</p>
<h3 id="初始化配置" tabindex="-1"><a class="header-anchor" href="#初始化配置"><span>初始化配置</span></a></h3>
<p>读到<code v-pre>src/configs/app.config.json</code>编译后的配置文件内容并传递给<code v-pre>@aep/aep-configuration</code>。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token comment">// import { ConfigurationResolver } from '@aep/aep-configuration';</span></span>
<span class="line">ConfigurationResolver<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>appConfigPath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong><a href="http://192.9.200.187/aep/aep-configuration/tree/develop" target="_blank" rel="noopener noreferrer">@aep/aep-configuration</a></strong></p>
<p>通过<code v-pre>ConfigurationResolver.configure</code>方法将配置文件路径传入并在内部解析，后将配置文件中<code v-pre>configSections</code>字段下的数据保存在内部的一个Map中，可通过<code v-pre>resolveFromAppConfig</code>及<code v-pre>resolve</code>方法获取其中的配置。</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/Eclipse-Thiea/AEP平台功能点梳理及整理（部分）/2.png" alt="@aep/aep-configuration"></p>
<h3 id="初始化环境路径" tabindex="-1"><a class="header-anchor" href="#初始化环境路径"><span>初始化环境路径</span></a></h3>
<p>将当前应用的根目录及exe路径保存在<code v-pre>@aep/aep-framework</code>中。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token comment">// import { WorkingDirectory } from '@aep/aep-framework';</span></span>
<span class="line">WorkingDirectory<span class="token punctuation">.</span>appHome <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">WorkingDirectory<span class="token punctuation">.</span>exePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token string">'exe'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong><a href="http://192.9.200.187/aep/aep-framework" target="_blank" rel="noopener noreferrer">@aep/aep-framework</a></strong></p>
<p>对于<code v-pre>@aep/aep-framework</code>的描述大概是<strong>放一些功能点比较小不适合单独做成包的代码</strong>，其中包括<code v-pre>Encoding</code>、<code v-pre>EventHub</code>和<code v-pre>WorkingDirectory</code>等相关功能。</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/Eclipse-Thiea/AEP平台功能点梳理及整理（部分）/3.png" alt="@aep/aep-framework-desc"></p>
<p>其中<code v-pre>WorkingDirectory</code>中可以获取<code v-pre>资源主目录</code>，<code v-pre>exe路径</code>，<code v-pre>临时文件夹</code>，<code v-pre>资源目录</code>，<code v-pre>广告目录</code>，<code v-pre>配置目录</code>，<code v-pre>更新程序目录</code>，<code v-pre>更新程序参数</code>和<code v-pre>更新程序是否启用</code>；上文的<code v-pre>appHome</code>和<code v-pre>exePath</code>均为外部设置。</p>
<h3 id="初始化应用参数" tabindex="-1"><a class="header-anchor" href="#初始化应用参数"><span>初始化应用参数</span></a></h3>
<p>将应用信息及插件目录传递给<code v-pre>@aep/aep-schedule</code>中的<code v-pre>ScheduleOptions</code>：</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token keyword">const</span> scheduleOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">scheduleOptions<span class="token punctuation">.</span>isDev <span class="token operator">=</span> isDev<span class="token punctuation">;</span></span>
<span class="line">scheduleOptions<span class="token punctuation">.</span>appHome <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">scheduleOptions<span class="token punctuation">.</span>exePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token string">'exe'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">scheduleOptions<span class="token punctuation">.</span>pluginDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>scheduleOptions<span class="token punctuation">.</span>appHome<span class="token punctuation">,</span> <span class="token string">'../node_modules/@aep-plugins/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong><a href="http://192.9.200.187/aep/aep-schedule/tree/develop" target="_blank" rel="noopener noreferrer">@aep/aep-schedule</a></strong></p>
<p><code v-pre>@aep/aep-schedule</code>在aep中定义为一个任务管理器，其中<code v-pre>ScheduleTaskManager</code>继承了<a href="https://www.npmjs.com/package/events" target="_blank" rel="noopener noreferrer">events</a>的<code v-pre>EventEmitter</code>并返回一个单例，可以通过<code v-pre>.on</code>和<code v-pre>.emit</code>进行事件监听及触发：</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ScheduleTaskManager</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span></span>
<span class="line">    	<span class="token keyword">private</span> <span class="token keyword">static</span> readonly _instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleTaskManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line">    	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        	<span class="token keyword">return</span> ScheduleTaskManager<span class="token punctuation">.</span>_instance<span class="token punctuation">;</span></span>
<span class="line">    	<span class="token punctuation">}</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code v-pre>ScheduleTaskManager</code>中还有一个重要的方法是<code v-pre>startupAsync</code>会在启动任务中被调用，它的作用是获取<code v-pre>app.config.json</code>配置文件中的启动任务配置并依次实例化并执行其中的<code v-pre>executeAsync</code>方法，大致流程如下图：</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/Eclipse-Thiea/AEP平台功能点梳理及整理（部分）/4.png" alt="startupAsync"></p>
<p>其中还会导出<code v-pre>ScheduleOptions</code>类主要是为了规范配置格式，会在任务执行的时候作为入参传入。</p>
<p>至此已将应用相关信息及配置文件都提供给平台提供的运行时包中。</p>
<h3 id="创建窗口" tabindex="-1"><a class="header-anchor" href="#创建窗口"><span>创建窗口</span></a></h3>
<p>在electron的<code v-pre>ready</code>初始化生命周期中调用<code v-pre>@aep/aep-windows</code>提供的方法打开一个窗口并显示为启动页(如下图)，会在此期间执行启动任务，并在启动任务完成后关闭启动页：</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token keyword">await</span> splashWindow<span class="token punctuation">.</span><span class="token function">showAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeStartupTask</span><span class="token punctuation">(</span>scheduleOptions<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">splashWindow<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="@source/AB产品知识库/images/知识探索/前端/Eclipse-Thiea/AEP平台功能点梳理及整理（部分）/5.png" alt="AEP启动页"></p>
<h3 id="启动任务——executestartuptask" tabindex="-1"><a class="header-anchor" href="#启动任务——executestartuptask"><span>启动任务——executeStartupTask</span></a></h3>
<p>启动任务中主要调用了上文<code v-pre>@aep/aep-schedule</code>包中<code v-pre>ScheduleTaskManager</code>的<code v-pre>startupAsync</code>方法，上面已经介绍了实现原理。这里我们看下在启动时默认的配置文件中都执行了哪些任务。</p>
<p><strong>app.config.json</strong></p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token string-property property">"scheduleTaskSettings"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">"startupTasks"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"检查更新程序依赖"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"CheckUpdaterShellTask"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-schedule-task"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"启动运行平台"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"StartupPlatformTask"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-schedule-task"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"启动消息中转服务"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"StartMessageHubTask"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-schedule-task"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"注册插件远程调用服务"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"RegisterPluginToHubTask"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-schedule-task"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"注册对话框"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"RegisterDialogTask"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-schedule-task"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"启动子应用"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"StartSubProgramsTask"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-schedule-task"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"启动代理服务"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"StartStaticFileServerTask"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-schedule-task"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"启动静态页面服务"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"StartAgentServerTask"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-schedule-task"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"显示交易窗口"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"ShowWindowsTask"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-schedule-task"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">"endTasks"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-插件" tabindex="-1"><a class="header-anchor" href="#_3-插件"><span>3.插件</span></a></h2>
<p>在主进程入口文件中注意到有个插件文件夹的配置，并且在对应位置确实发现存在很多<code v-pre>@aep-plugins</code>开头的包，那么这个配置是在哪被读取的？并且这些包时什么时候如何被调用的呢？</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/Eclipse-Thiea/AEP平台功能点梳理及整理（部分）/6.png" alt="plugin-process"></p>
<h3 id="加载插件" tabindex="-1"><a class="header-anchor" href="#加载插件"><span>加载插件</span></a></h3>
<p>在启动任务中的其中一个是<strong>启动运行平台</strong>：</p>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre v-pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"启动运行平台"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"StartupPlatformTask"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-schedule-task"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据上文的启动任务的调用原理，会调用对应实例的<code v-pre>executeAsync</code>方法：</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">StartupPlatformTask</span> <span class="token keyword">implements</span> <span class="token class-name">IScheduleTask</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// ...</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">executeAsync</span><span class="token punctuation">(</span>context<span class="token operator">:</span> IScheduleContext<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        <span class="token function">startup</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中<code v-pre>startup</code>方法中做了4件事，分别是：<code v-pre>初始化IOC</code>、<code v-pre>检查license</code>、<code v-pre>二级公钥验证</code>和<code v-pre>加载插件</code>，这里我们先看<code v-pre>加载插件</code>，其余的会在后文提到。</p>
<p><strong><a href="http://192.9.200.187/aep/aep-startup/blob/develop/src/lib/Startup.js" target="_blank" rel="noopener noreferrer">@aep/aep-startup -&gt; Startup.js</a></strong></p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line">exports<span class="token punctuation">.</span><span class="token function-variable function">startup</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">startup</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[startup]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">initIoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">checkLicence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">verifyAepPackage</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>pluginDir<span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">loadPlugins</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>pluginDir<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的<code v-pre>context.pluginDir</code>就是上文在主进程入口文件中配置的插件文件夹(<code v-pre>node_modules/@aep-plugins/</code>)，最终调用到了<a href="http://192.9.200.187/aep/aep-bridge/tree/develop" target="_blank" rel="noopener noreferrer"><code v-pre>@aep/aep-bridge</code></a>中的<code v-pre>loadPlugins</code>方法，此时仅将插件列表信息保存在了数组中，在需要调用插件时使用<code v-pre>getPlugin</code>方法获取后调用插件中方法：</p>
<p><strong><a href="http://192.9.200.187/aep/aep-bridge/blob/develop/src/PluginManager.ts" target="_blank" rel="noopener noreferrer">@aep/aep-bridge -&gt; PluginManager.ts</a></strong></p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token function">loadPlugins</span><span class="token punctuation">(</span>pluginsDir<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> serviceName <span class="token operator">===</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>_pluginsList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      serviceName<span class="token punctuation">,</span></span>
<span class="line">      packageName</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> serviceName<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> service <span class="token operator">=</span> serviceName<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>_pluginsList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">serviceName</span><span class="token operator">:</span> service<span class="token punctuation">,</span></span>
<span class="line">        packageName</span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token function">getPlugin</span><span class="token punctuation">(</span>service<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> IPlugin <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> packageName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pluginsList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> item<span class="token punctuation">.</span>serviceName <span class="token operator">===</span> service<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>packageName<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span>packageName <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="调用插件" tabindex="-1"><a class="header-anchor" href="#调用插件"><span>调用插件</span></a></h3>
<p>在启动任务中的<strong>注册插件远程调用服务(RegisterPluginToHubTask)</strong>，在此服务中注册了<code v-pre>executePlugin</code>命令，在需要调用插件的地方可以触发这个命令即可执行对应插件的方法：</p>
<p><strong><a href="http://192.9.200.187/aep/aep-schedule-task/blob/develop/src/lib/RegisterPluginToHubTask.ts" target="_blank" rel="noopener noreferrer">@aep/aep-schedule-task -&gt; RegisterPluginToHubTask.ts</a></strong></p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">RegisterPluginToHubTask</span> <span class="token keyword">implements</span> <span class="token class-name">IScheduleTask</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token function">executeAsync</span><span class="token punctuation">(</span>context<span class="token operator">:</span> IScheduleContext<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> ws <span class="token operator">=</span> globalContainer<span class="token punctuation">.</span>resolve<span class="token operator">&lt;</span>IPeer<span class="token operator">></span><span class="token punctuation">(</span><span class="token string">"IShellPeer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ws<span class="token punctuation">.</span><span class="token function">registerCommand</span><span class="token punctuation">(</span><span class="token string">'executePlugin'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>executePlugin<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">async</span> <span class="token function">executePlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">msg</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">const</span> plugin <span class="token operator">=</span> pluginManager<span class="token punctuation">.</span><span class="token function">getPlugin</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span> <span class="token keyword">as</span> any<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        <span class="token keyword">const</span> callbackContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CallbackContext</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plugin<span class="token punctuation">[</span>service<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                plugin<span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> callbackContext<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                plugin<span class="token punctuation">[</span>that<span class="token punctuation">.</span><span class="token function">toLowerCaseTitle</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> callbackContext<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">[</span>service<span class="token punctuation">]</span><span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                plugin<span class="token punctuation">[</span>service<span class="token punctuation">]</span><span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> callbackContext<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                plugin<span class="token punctuation">[</span>service<span class="token punctuation">]</span><span class="token punctuation">[</span>that<span class="token punctuation">.</span><span class="token function">toLowerCaseTitle</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> callbackContext<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-ioc" tabindex="-1"><a class="header-anchor" href="#_4-ioc"><span>4.IoC</span></a></h2>
<p>在<code v-pre>app.config.json</code>中发现一个配置项叫做<code v-pre>iocSettings</code>，通过字面意思大概能猜测到这个配置项的作用，并且在上文<em>加载插件</em>的时候也有使用到相关代码<code v-pre>globalContainer.resolve&lt;IPeer&gt;(&quot;IShellPeer&quot;)</code>，那么在AEP中到底是如何实现的IoC呢？</p>
<p><code v-pre>iocSettings</code>配置大致如下：</p>
<p><strong>app.config.json</strong></p>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre v-pre><code><span class="line"><span class="token property">"iocSettings"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">"injections"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">"interface"</span><span class="token operator">:</span> <span class="token string">"IDeviceManager"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"implement"</span><span class="token operator">:</span> <span class="token string">"LocalDeviceManager"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-device-wosa"</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">"interface"</span><span class="token operator">:</span> <span class="token string">"IEventHubClient"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"implement"</span><span class="token operator">:</span> <span class="token string">"EventHubClient"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-framework"</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">"interface"</span><span class="token operator">:</span> <span class="token string">"IMessageHub"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"implement"</span><span class="token operator">:</span> <span class="token string">"WSHub"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-hub-ws"</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">"interface"</span><span class="token operator">:</span> <span class="token string">"IShellPeer"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"implement"</span><span class="token operator">:</span> <span class="token string">"ShellWSPeer"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-hub-ws"</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">"interface"</span><span class="token operator">:</span> <span class="token string">"/Start"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"implement"</span><span class="token operator">:</span> <span class="token string">"StartServiceHandler"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-agent-handlers"</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">"interface"</span><span class="token operator">:</span> <span class="token string">"/Pause"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"implement"</span><span class="token operator">:</span> <span class="token string">"PauseServiceHandler"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-agent-handlers"</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">"interface"</span><span class="token operator">:</span> <span class="token string">"/SystemClose"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"implement"</span><span class="token operator">:</span> <span class="token string">"SystemShutdownHandler"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-agent-handlers"</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">"interface"</span><span class="token operator">:</span> <span class="token string">"/SystemRestart"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"implement"</span><span class="token operator">:</span> <span class="token string">"SystemRestartHandler"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-agent-handlers"</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AEP中实现IoC的原理大致如下：</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/Eclipse-Thiea/AEP平台功能点梳理及整理（部分）/7.png" alt="aep-ioc"></p>
<p>配置文件中的<code v-pre>interface</code>对应保存到Map中的<code v-pre>token</code>，<code v-pre>implement</code>为<code v-pre>package</code>包中的类名对应保存到Map中的<code v-pre>useClass</code>，后续可通过<code v-pre>resolve(token)</code>获取对应注册的实例。</p>
<p>关键代码如下：</p>
<p><strong><a href="http://192.9.200.187/aep/aep-di/blob/develop/src/container.ts" target="_blank" rel="noopener noreferrer">@aep/aep-di -&gt; container.ts</a></strong></p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token generic-function"><span class="token function">register</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>providers<span class="token operator">:</span> IProvider<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> providers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> provider<span class="token operator">:</span> IProvider<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token operator">=</span> providers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">registerOne</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token generic-function"><span class="token function">registerByConfig</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>iocSettings<span class="token operator">:</span> IocSettings<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> providers<span class="token operator">:</span> IProvider<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> iocSettings<span class="token punctuation">.</span>injections<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> injection<span class="token operator">:</span> Injection <span class="token operator">=</span> iocSettings<span class="token punctuation">.</span>injections<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> packageObj <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span>injection<span class="token punctuation">.</span>package<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> implementCtor<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>injection<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            implementCtor <span class="token operator">=</span> <span class="token operator">&lt;</span>Constructor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">>></span>packageObj<span class="token punctuation">[</span>injection<span class="token punctuation">.</span>namespace<span class="token punctuation">]</span><span class="token punctuation">[</span>injection<span class="token punctuation">.</span>implement<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            implementCtor <span class="token operator">=</span> <span class="token operator">&lt;</span>Constructor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">>></span>packageObj<span class="token punctuation">[</span>injection<span class="token punctuation">.</span>implement<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        providers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>IProvider<span class="token operator">></span><span class="token punctuation">{</span></span>
<span class="line">            token<span class="token operator">:</span> injection<span class="token punctuation">.</span>interface<span class="token punctuation">,</span></span>
<span class="line">            useClass<span class="token operator">:</span> implementCtor</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">register</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>providers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token generic-function"><span class="token function">resolve</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>token<span class="token operator">:</span> InjectionToken<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> registryDataList <span class="token operator">=</span> <span class="token operator">&lt;</span>IRegistryData<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token keyword">this</span><span class="token punctuation">.</span>_registry<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">    <span class="token keyword">const</span> registryData <span class="token operator">=</span> registryDataList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>registryData<span class="token punctuation">.</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> registryData<span class="token punctuation">.</span>instance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>Constructor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">>></span>registryData<span class="token punctuation">.</span>ctor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    registryData<span class="token punctuation">.</span>instance <span class="token operator">=</span> instance<span class="token punctuation">;</span></span>
<span class="line">    registryDataList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>registryData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>_registry<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> registryDataList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span>instance<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token generic-function"><span class="token function">registerOne</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>provider<span class="token operator">:</span> IProvider<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> registryData<span class="token operator">:</span> IRegistryData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegistryData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> ctor <span class="token operator">=</span> <span class="token operator">&lt;</span>Constructor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">>></span>provider<span class="token punctuation">.</span>useClass<span class="token punctuation">;</span></span>
<span class="line">    registryData<span class="token punctuation">.</span>ctor <span class="token operator">=</span> ctor</span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>_registry<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">,</span> <span class="token punctuation">[</span>registryData<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-验证签名" tabindex="-1"><a class="header-anchor" href="#_5-验证签名"><span>5.验证签名</span></a></h2>
<p>校验分两种，一个是应用的license校验，另一个是插件包的二级校验。</p>
<h3 id="license校验" tabindex="-1"><a class="header-anchor" href="#license校验"><span>license校验</span></a></h3>
<p>通过之前保存在<code v-pre>WorkingDirectory</code>中的信息获取到应用根目录下的<code v-pre>license.json</code>文件，然后通过其中内容获取到<code v-pre>verifyContent</code>和签名<code v-pre>signature</code>。然后通过<code v-pre>@aep/aep-licence</code>包中的公钥文件<code v-pre>publicKey.pem</code>生成用于校验的<code v-pre>publicKey</code>，然后通过<a href=""><code v-pre>crypto</code></a>使用<code v-pre>publicKey</code>和<code v-pre>signature</code>得到校验结果。</p>
<p>核心代码如下：</p>
<p><strong><a href="http://192.9.200.187/aep/aep-startup/blob/develop/src/lib/Startup.js" target="_blank" rel="noopener noreferrer">@aep/aep-startup -&gt; Startup.js</a></strong></p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">verifyLicenceSync</span><span class="token punctuation">(</span>verifyContent<span class="token punctuation">,</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[verifyLicenceSync]signature:"</span> <span class="token operator">+</span> signature<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> packagePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"@aep/aep-licence/package.json"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> publicKeyPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>packagePath<span class="token punctuation">,</span> <span class="token string">"publicKey.pem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> publicKeyString <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>publicKeyPath<span class="token punctuation">,</span> <span class="token punctuation">{</span> encoding<span class="token operator">:</span> <span class="token string">"utf-8"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> publicKey <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        key<span class="token operator">:</span> publicKeyString<span class="token punctuation">,</span></span>
<span class="line">        type<span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span></span>
<span class="line">        format<span class="token operator">:</span> <span class="token string">'pem'</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> verify <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createVerify</span><span class="token punctuation">(</span><span class="token string">'SHA256'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    verify<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>verifyContent<span class="token punctuation">)</span></span>
<span class="line">    verify<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> verify<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="包校验" tabindex="-1"><a class="header-anchor" href="#包校验"><span>包校验</span></a></h3>
<p>在AEP中校验的包为<code v-pre>@aep</code>和<code v-pre>@aep-plugins</code>两个组下<code v-pre>node_modules</code>中的包。</p>
<p>第一层校验，获取当前包除<code v-pre>.d.ts</code>、<code v-pre>.json</code>和<code v-pre>.js.map</code>文件外每个文件内容的MD5值拼接在一起再计算出一个MD5值，通过在发布包的<code v-pre>package.json</code>中的<code v-pre>signData</code>和<code v-pre>publicKey</code>信息进行自检。</p>
<p>第二层校验，先获取<code v-pre>@aep/aep-startup</code>包中的公钥<code v-pre>publicKey.pem</code>，然后再通过在发布包的<code v-pre>package.json</code>中的<code v-pre>publicKey</code>和<code v-pre>publicKeySgin</code>信息进行二次公钥校验。</p>
<p>包中的<code v-pre>package.json</code>中签名和公钥相关代码如下(以下代码取自<code v-pre>@aep/aep-common@5.2.22</code>)：</p>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre v-pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">	<span class="token property">"signData"</span><span class="token operator">:</span> <span class="token string">"hgJ2ogqggjRNFD3rEiiTYUw3p/UPNPCkngYDEaULXxhEEvqC6rGnHA+i/WSqS9DUa2H3XmPrVssNyJfZ1QQsPw=="</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"publicKey"</span><span class="token operator">:</span> <span class="token string">"-----BEGIN PUBLIC KEY-----\r\nMFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAIfBr/Ncxpt4IIusOO7RnprEyx4f7aud\r\nWG9IHyAfHcs+oVCXnzvr/mKjusoknbzwQHMvazjP6nfk7b1HGTw/2vsCAwEAAQ==\r\n-----END PUBLIC KEY-----"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"publicKeySgin"</span><span class="token operator">:</span> <span class="token string">"e2i4oLARmS4Mht5p0VQIyBx+g7vT2s4bJ47sTJI6PnaC2pRHKSz9tYi9YQry6g8Qc/WMEwXeCPxDKChHHHuMGQ=="</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-消息通讯-启动消息中转服务" tabindex="-1"><a class="header-anchor" href="#_6-消息通讯-启动消息中转服务"><span>6.消息通讯（启动消息中转服务）</span></a></h2>
<p>接着我们看在<strong>启动运行平台</strong>任务后的<strong>启动消息中转服务</strong>任务。任务信息如下：</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"启动消息中转服务"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"StartMessageHubTask"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-schedule-task"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其执行的核心代码如下：</p>
<p><strong><a href="http://192.9.200.187/aep/aep-schedule-task/blob/develop/src/lib/StartMessageHubTask.ts" target="_blank" rel="noopener noreferrer">@aep/aep-schedule-task -&gt; StartMessageHubTask.ts</a></strong></p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">StartMessageHubTask</span> <span class="token keyword">implements</span> <span class="token class-name">IScheduleTask</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// ...</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">executeAsync</span><span class="token punctuation">(</span>context<span class="token operator">:</span> ScheduleOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 启动MessageHub</span></span>
<span class="line">        <span class="token keyword">const</span> hub <span class="token operator">=</span> globalContainer<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">resolve</span><span class="token generic class-name"><span class="token operator">&lt;</span>IMessageHub<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'IMessageHub'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> hub<span class="token punctuation">.</span><span class="token function">startAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调用<code v-pre>startAsync</code>启动报文交换服务，在连接成功后注册消息处理函数<code v-pre>onmessage</code>，若是“注册”类型则<code v-pre>new WSPeerChannel</code>并保存在<code v-pre>_channels</code>中，若为“消息处理”类型，则从<code v-pre>_channels</code>中取到对应<code v-pre>peer</code>并调用<code v-pre>send</code>方法。报文交换服务关键代码如下：</p>
<p><strong><a href="http://192.9.200.187/aep/aep-hub-ws/blob/develop/src/WSHub.ts" target="_blank" rel="noopener noreferrer">@aep/aep-hub-ws -&gt; WSHub.ts</a></strong></p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">WSHub</span> <span class="token keyword">implements</span> <span class="token class-name">IMessageHub</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_channels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerChannelRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">private</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_httpServer <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// ...</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_wsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            httpServer<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_httpServer<span class="token punctuation">,</span></span>
<span class="line">            autoAcceptConnections<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">            maxReceivedFrameSize<span class="token operator">:</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">            maxReceivedMessageSize<span class="token operator">:</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 监听连接事件，处理新建立的连接</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_wsServer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> conn <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onConnection</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">private</span> <span class="token function">onConnection</span><span class="token punctuation">(</span>conn<span class="token operator">:</span> WSConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        conn<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 转换报文为json对象</span></span>
<span class="line">                <span class="token keyword">let</span> request <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                    request <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>utf8Data<span class="token punctuation">)</span> <span class="token keyword">as</span> IRequest<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// ...</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">                <span class="token comment">// 注册报文处理</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type <span class="token operator">==</span> MessageType<span class="token punctuation">.</span>register<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">const</span> peerName <span class="token operator">=</span> request<span class="token punctuation">.</span>from<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">const</span> peer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WSPeerChannel</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> peerName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token comment">// ...</span></span>
<span class="line">                    <span class="token keyword">this</span><span class="token punctuation">.</span>Channels<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>peerName<span class="token punctuation">,</span> peer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">                <span class="token comment">// 转发报文</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type <span class="token operator">==</span> MessageType<span class="token punctuation">.</span>send <span class="token operator">||</span></span>
<span class="line">                    request<span class="token punctuation">.</span>type <span class="token operator">==</span> MessageType<span class="token punctuation">.</span>sendAck <span class="token operator">||</span></span>
<span class="line">                    request<span class="token punctuation">.</span>type <span class="token operator">==</span> MessageType<span class="token punctuation">.</span>request <span class="token operator">||</span></span>
<span class="line">                    request<span class="token punctuation">.</span>type <span class="token operator">==</span> MessageType<span class="token punctuation">.</span>requestAck <span class="token operator">||</span></span>
<span class="line">                    request<span class="token punctuation">.</span>type <span class="token operator">==</span> MessageType<span class="token punctuation">.</span>response <span class="token operator">||</span></span>
<span class="line">                    request<span class="token punctuation">.</span>type <span class="token operator">==</span> MessageType<span class="token punctuation">.</span>responseAck<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 处理请求</span></span>
<span class="line">                    <span class="token keyword">const</span> targetPeerName <span class="token operator">=</span> request<span class="token punctuation">.</span>to<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Channels<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>targetPeerName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">const</span> peer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Channels<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>targetPeerName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        peer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>utf8Data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token comment">// ...</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// ...</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">startAsync</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// ...</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_httpServer<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">public</span> <span class="token function">stopAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_port <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_httpServer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_httpServer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_httpServer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>err <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>WSPeerChannel</code>实现如下：</p>
<p><strong><a href="http://192.9.200.187/aep/aep-hub-ws/blob/develop/src/WSPeerChannel.ts" target="_blank" rel="noopener noreferrer">@aep/aep-hub-ws -&gt; WSPeerChannel.ts</a></strong></p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">WSPeerChannel</span> <span class="token keyword">implements</span> <span class="token class-name">IPeerChannel</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * peer名称</span>
<span class="line">     */</span></span>
<span class="line">    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * ws连接</span>
<span class="line">     */</span></span>
<span class="line">    conn<span class="token operator">:</span> WSConnection</span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 构造一个Peer对象</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span>conn<span class="token operator">:</span> WSConnection<span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>conn <span class="token operator">=</span> conn<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token function-variable function">event</span><span class="token operator">:</span> <span class="token punctuation">(</span>msg<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> data <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">event</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>utf8Data<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">sendUTF</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面以上文中注册<code v-pre>executePlugin</code>命令中用到的<code v-pre>globalContainer.resolve&lt;IPeer&gt;(&quot;IShellPeer&quot;)</code>为例，直接找到对应的类：</p>
<p><strong><a href="http://192.9.200.187/aep/aep-hub-ws/blob/develop/src/ShellWSPeer.ts" target="_blank" rel="noopener noreferrer">@aep/aep-hub-ws -&gt; ShellWSPeer.ts</a></strong></p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ShellWSPeer</span> <span class="token keyword">extends</span> <span class="token class-name">WSPeer</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> hub <span class="token operator">=</span> globalContainer<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">resolve</span><span class="token generic class-name"><span class="token operator">&lt;</span>IMessageHub<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'IMessageHub'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ws://127.0.0.1:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hub<span class="token punctuation">.</span>Port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span>
<span class="line">            name<span class="token operator">:</span> <span class="token string">'aep-shell'</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过实例化好的<code v-pre>WSHub</code>拿到WebSocket端口传入<code v-pre>WSPeer</code>，<code v-pre>WSPeer</code>实现如下：</p>
<p><strong><a href="http://192.9.200.187/aep/aep-hub-ws/blob/develop/src/WSPeer.ts" target="_blank" rel="noopener noreferrer">@aep/aep-hub-ws -&gt; WSPeer.ts</a></strong></p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * WebSocket实现的消息中转客户端</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">WSPeer</span> <span class="token keyword">implements</span> <span class="token class-name">IPeer</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// ...</span></span>
<span class="line">	<span class="token keyword">public</span> <span class="token function">registerCommand</span><span class="token punctuation">(</span>cmd<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> value<span class="token operator">:</span> CommandHandler<span class="token punctuation">,</span> thisArg<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>commandRegister<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> value<span class="token punctuation">,</span> thisArg <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// ...</span></span>
<span class="line">	<span class="token doc-comment comment">/**</span>
<span class="line">     * 构造一个WSPeer</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">context</span> </span>
<span class="line">     * eg:</span>
<span class="line">     * context.url = 'ws://127.0.0.1:8000'</span>
<span class="line">     * context.name = 'acap-web'</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_url <span class="token operator">=</span> context<span class="token punctuation">.</span>url<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_name <span class="token operator">=</span> context<span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createWebSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// ...</span></span>
<span class="line">	<span class="token keyword">private</span> <span class="token function">createWebSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> WSConnection<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onConnect</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connectFailed'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Error<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_ws<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// ...</span></span>
<span class="line">	<span class="token keyword">private</span> <span class="token function">onConnect</span><span class="token punctuation">(</span>e<span class="token operator">:</span> WSConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_conn <span class="token operator">=</span> e<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_conn<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> data <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onMsg</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_conn<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>code<span class="token punctuation">,</span> desc<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_conn<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> err <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 发送注册报文</span></span>
<span class="line">        <span class="token keyword">const</span> register <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegisterRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        register<span class="token punctuation">.</span>from <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> registerMsg <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>register<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_conn<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>registerMsg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// ...</span></span>
<span class="line">	<span class="token keyword">private</span> <span class="token function">onMsg</span><span class="token punctuation">(</span>e<span class="token operator">:</span> IWSMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_requests<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>cid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token comment">// ..</span></span>
<span class="line">		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token comment">// ...</span></span>
<span class="line">			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processSendMessge</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">			<span class="token comment">// ...</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// private processExchangeMesage</span></span>
<span class="line">	<span class="token keyword">private</span> <span class="token function">processSendMessge</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> IMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>commandRegister<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> commandInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commandRegister<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>command<span class="token punctuation">)</span></span>
<span class="line">            commandInfo<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>commandInfo<span class="token punctuation">.</span>thisArg<span class="token punctuation">,</span> <span class="token punctuation">[</span>req<span class="token punctuation">.</span>body<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-js与原生层通讯-显示交易窗口" tabindex="-1"><a class="header-anchor" href="#_7-js与原生层通讯-显示交易窗口"><span>7.js与原生层通讯（显示交易窗口）</span></a></h2>
<p>启动任务的最后一个为<strong>显示交易窗口</strong>，信息如下：</p>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre v-pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"显示交易窗口"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"ShowWindowsTask"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"package"</span><span class="token operator">:</span> <span class="token string">"@aep/aep-schedule-task"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通讯的方式大致如下图：</p>
<p><img src="@source/AB产品知识库/images/知识探索/前端/Eclipse-Thiea/AEP平台功能点梳理及整理（部分）/8.png" alt="js-native-bridge"></p>
<p>首先读取了配置文件中的窗体相关配置，然后注册了一个回调函数，值得注意的是在这里通过<a href="https://www.electronjs.org/docs/latest/api/web-contents#contentsexecutejavascriptcode-usergesture" target="_blank" rel="noopener noreferrer"><code v-pre>executeJavaScript</code></a>执行了一些js逻辑：</p>
<p><strong><a href="http://192.9.200.187/aep/aep-schedule-task/blob/develop/src/lib/ShowWindowsTask.ts" target="_blank" rel="noopener noreferrer">@aep/aep-schedule-task -&gt; ShowWindowsTask.ts</a></strong></p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token comment">// 注入报文交换程序端口到前端窗体</span></span>
<span class="line">WindowsManager<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"beforeWindowsLoaded"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">window</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[init]inject Hub port:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span>extraData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"messageHubPort"</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> webContents <span class="token operator">=</span> window<span class="token punctuation">.</span>browserWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">;</span></span>
<span class="line">    webContents<span class="token punctuation">.</span><span class="token function">executeJavaScript</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">window.Hub = {port:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span>extraData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"messageHubPort"</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后打开窗口<code v-pre>WindowsManager.showWindows()</code>，其中的主要工作为：</p>
<ul>
<li>实例化主窗口<code v-pre>new MainWindow</code></li>
<li>注册窗体事件，如：<code v-pre>.registerInvoker('windowAction')</code>和<code v-pre>.on('close')</code></li>
<li>注册窗口全局快捷键，如：<code v-pre>F12</code>、<code v-pre>F5</code>、<code v-pre>r</code>和<code v-pre>F4</code></li>
<li>绑定一些窗口生命周期回调函数</li>
<li>加载前端页面<code v-pre>window.loadURL</code></li>
</ul>
<blockquote>
<p>其中可以通过<code v-pre>window.renderBridge.executeJsMethod('windowEvent', 'mainWindowClose', null);</code>执行js方法。</p>
</blockquote>
<h3 id="mainwindow" tabindex="-1"><a class="header-anchor" href="#mainwindow"><span>MainWindow</span></a></h3>
<p>其中做了两件重要的事，第一个是创建了<code v-pre>electron</code>的<code v-pre>BrowserWindow</code>，为最终打开的窗口，并传入相关配置；第二个事实例化了js与原生层的bridge。代码如下：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MainWindow</span> <span class="token keyword">implements</span> <span class="token class-name">IWindow</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// ...</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span>windowConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createWindow</span><span class="token punctuation">(</span>windowConfig<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>renderBridge <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeInteropBridge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>renderBridge<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">	<span class="token function">createWindow</span><span class="token punctuation">(</span>windowConfig<span class="token operator">:</span> WindowsSetting<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line">		<span class="token keyword">this</span><span class="token punctuation">.</span>browserWindow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrowserWindow</span><span class="token punctuation">(</span>browserOptions<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有关第一点不做详细解释，主要关注第二点，也就是这个<code v-pre>NativeInteropBridge</code>，由于整体代码过多，这里只列出方法名及部分实现，详细代码可查看源码：</p>
<p><strong><a href="http://192.9.200.187/aep/aep-bridge/blob/develop/src/NativeInteropBridge.ts" target="_blank" rel="noopener noreferrer">@aep/aep-bridge -&gt; NativeInteropBridge.ts</a></strong></p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">NativeInteropBridge</span> <span class="token keyword">implements</span> <span class="token class-name">IBridge</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupIpcMainEventListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// 通知渲染层主进程就绪</span></span>
<span class="line">	<span class="token function">notifyRenderMainReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">this</span><span class="token punctuation">.</span>window<span class="token punctuation">.</span>browserWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">executeJavaScript</span><span class="token punctuation">(</span>BuiltInScripts<span class="token punctuation">.</span>nativeReady<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// 执行渲染进程的js方法</span></span>
<span class="line">	<span class="token function">executeJsMethod</span><span class="token punctuation">(</span>invoker<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> methodName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">this</span><span class="token punctuation">.</span>window<span class="token punctuation">.</span>browserWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"executeJsMethod"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            invoker<span class="token punctuation">,</span></span>
<span class="line">            methodName<span class="token punctuation">,</span></span>
<span class="line">            args</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// 执行渲染进程的异步js方法</span></span>
<span class="line">	<span class="token function">executeJsMethodAsync</span><span class="token punctuation">(</span>invoker<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> methodName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> args<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> requestId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">this</span><span class="token punctuation">.</span>window<span class="token punctuation">.</span>browserWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"executeJsMethodAsync"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            invoker<span class="token punctuation">,</span></span>
<span class="line">            methodName<span class="token punctuation">,</span></span>
<span class="line">            args<span class="token punctuation">,</span></span>
<span class="line">            requestId</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// 执行js回调</span></span>
<span class="line">	<span class="token function">executeJSCallback</span><span class="token punctuation">(</span>requestId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> isSuccess<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> result<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> requestId<span class="token punctuation">,</span> isSuccess<span class="token punctuation">,</span> result<span class="token punctuation">,</span> message <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"executeJSCallback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// 执行Native方法</span></span>
<span class="line">	<span class="token function">executeNativeMethod</span><span class="token punctuation">(</span>invokerName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> methodName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> requestId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">this</span><span class="token punctuation">.</span>nativeInvokerDispatcher<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invokerName<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> args<span class="token punctuation">,</span> requestId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// 单向执行Native方法</span></span>
<span class="line">	<span class="token function">oneWayExecuteNativeMethod</span><span class="token punctuation">(</span>invokerName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> methodName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">this</span><span class="token punctuation">.</span>nativeInvokerDispatcher<span class="token punctuation">.</span><span class="token function">oneWayInvoke</span><span class="token punctuation">(</span>invokerName<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// 返回插件执行结果到渲染进程</span></span>
<span class="line">	<span class="token function">sendPluginResult</span><span class="token punctuation">(</span>pluginResult<span class="token operator">:</span> PluginResult<span class="token punctuation">,</span> callbackId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token string">"plugin"</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> isSuccess<span class="token punctuation">,</span> message<span class="token punctuation">,</span> result<span class="token punctuation">,</span> keepCallback <span class="token punctuation">}</span> <span class="token operator">=</span> pluginResult<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            type<span class="token punctuation">,</span></span>
<span class="line">            pluginResult<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                message<span class="token punctuation">,</span></span>
<span class="line">                result<span class="token punctuation">,</span></span>
<span class="line">                keepCallback</span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            callbackId<span class="token punctuation">,</span></span>
<span class="line">            isSuccess</span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// 发送报文到渲染进程</span></span>
<span class="line">	<span class="token function">send</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> channel <span class="token operator">=</span> <span class="token string">"message"</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">      	<span class="token keyword">this</span><span class="token punctuation">.</span>window<span class="token punctuation">.</span>browserWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// 安装IpcMain事件监听器</span></span>
<span class="line">	<span class="token function">setupIpcMainEventListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		ipcMain<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"execute-plugin"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		ipcMain<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"executeNativeMethod"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		ipcMain<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"oneWayExecuteNativeMethod"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		ipcMain<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"executeJSCallback"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主要分两种，一种是与渲染进程(前端js)交互，另一种是与原生层(Native)交互，其中与渲染进程交互其核心为<code v-pre>webContents.send(channel)</code>可在渲染进程通过<code v-pre>ipcRenderer.on(channel, () =&gt; {})</code>接受消息进行处理，这里是有关<code v-pre>send</code>方法的<a href="https://www.electronjs.org/docs/latest/api/web-contents#contentssendchannel-args" target="_blank" rel="noopener noreferrer">官方文档</a>。
与原生层交互首先通过<code v-pre>ipcMain.on</code>的监听事件，然后通过<code v-pre>NativeInvokerDispatcher</code>，通过注册的<code v-pre>invokerName</code>找到对一个方法，然后传入参数并执行，关键代码如下：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">NativeInvokerDispatcher</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token function">invoke</span><span class="token punctuation">(</span>invokerName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> methodName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> requestId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line">		<span class="token keyword">const</span> invoker <span class="token operator">=</span> globalInvokerRegistry<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>invokerName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line">		<span class="token keyword">const</span> invokerAction <span class="token operator">=</span> invoker<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          	result <span class="token operator">=</span> <span class="token function">invokerAction</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> args<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">          	result <span class="token operator">=</span> <span class="token function">invokerAction</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> <span class="token punctuation">[</span>args<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pluginexectutor" tabindex="-1"><a class="header-anchor" href="#pluginexectutor"><span>PluginExectutor</span></a></h3>
<p>同时，通过<code v-pre>NativeInteropBridge</code>也可以执行插件的方法，通过内部的<code v-pre>PluginExectutor</code>，代码如下：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">NativeInteropBridge</span> <span class="token keyword">implements</span> <span class="token class-name">IBridge</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">private</span> _pluginExecutor<span class="token operator">:</span> PluginExecutor</span>
<span class="line">	<span class="token comment">// ...</span></span>
<span class="line">	<span class="token keyword">get</span> <span class="token function">pluginExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> PluginExecutor <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pluginExecutor<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">set</span> <span class="token function">pluginExecutor</span><span class="token punctuation">(</span>value<span class="token operator">:</span> PluginExecutor<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pluginExecutor <span class="token operator">=</span> value<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong><a href="http://192.9.200.187/aep/aep-bridge/blob/develop/src/PluginExecutor.ts" target="_blank" rel="noopener noreferrer">@aep/aep-bridge -&gt; PluginExecutor.ts</a></strong></p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">PluginExectutor</span> <span class="token keyword">implements</span> <span class="token class-name">IPluginExecutor</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// ...</span></span>
<span class="line">	<span class="token keyword">get</span> <span class="token function">pluginManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> IPluginManager <span class="token punctuation">{</span> <span class="token keyword">return</span> PluginManager<span class="token punctuation">.</span>instance<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token function">exec</span><span class="token punctuation">(</span>service<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> action<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> callbackId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> args<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line">		<span class="token keyword">const</span> plugin <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginManager<span class="token punctuation">.</span><span class="token function">getPlugin</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plugin<span class="token punctuation">[</span>service<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              	plugin<span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span> callbackContext<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">              	plugin<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toLowerCaseTitle</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span> callbackContext<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">var</span> actions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>plugin<span class="token punctuation">[</span>service<span class="token punctuation">]</span><span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// ...</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">[</span>service<span class="token punctuation">]</span><span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              	plugin<span class="token punctuation">[</span>service<span class="token punctuation">]</span><span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span> callbackContext<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">              	plugin<span class="token punctuation">[</span>service<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toLowerCaseTitle</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span> callbackContext<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">		<span class="token comment">// ...</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-应用更新" tabindex="-1"><a class="header-anchor" href="#_8-应用更新"><span>8.应用更新</span></a></h2>
<h3 id="冷更新" tabindex="-1"><a class="header-anchor" href="#冷更新"><span><a href="http://192.9.200.187/aep/aep-update-cold" target="_blank" rel="noopener noreferrer">冷更新</a></span></a></h3>
<h3 id="热更新" tabindex="-1"><a class="header-anchor" href="#热更新"><span><a href="http://192.9.200.187/aep/aep-update-hot" target="_blank" rel="noopener noreferrer">热更新</a></span></a></h3>
<h3 id="更新基础框架" tabindex="-1"><a class="header-anchor" href="#更新基础框架"><span><a href="http://192.9.200.187/aep/aep-update-framework" target="_blank" rel="noopener noreferrer">更新基础框架</a></span></a></h3>
<h2 id="_9-代理agent" tabindex="-1"><a class="header-anchor" href="#_9-代理agent"><span>9.代理agent</span></a></h2>
<p><a href="http://192.9.200.187/aep/aep-agent" target="_blank" rel="noopener noreferrer">aep-agent</a>
<a href="http://192.9.200.187/aep/aep-agent-handlers" target="_blank" rel="noopener noreferrer">aep-agent-handlers</a></p>
</div></template>



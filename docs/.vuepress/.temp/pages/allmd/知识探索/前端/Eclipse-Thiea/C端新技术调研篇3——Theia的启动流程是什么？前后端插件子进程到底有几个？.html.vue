<template><div><h2 id="theia的启动流程" tabindex="-1"><a class="header-anchor" href="#theia的启动流程"><span>Theia的启动流程</span></a></h2>
<p>在研究Theia插件子进程到底有几个之前，我们需要深入调研探讨一下Theia的启动流程。
在基于Theia提供的开发工程<a href="https://theia-ide.org/docs/composing_applications" target="_blank" rel="noopener noreferrer">Build your own IDE</a>里，我们看到package.json当<code v-pre>npm run dev</code>时，实际上执行的是<code v-pre>theia start</code>命令。</p>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre v-pre><code><span class="line"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token property">"prepare"</span><span class="token operator">:</span> <span class="token string">"yarn run clean &amp;&amp; yarn build &amp;&amp; yarn run download:plugins"</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token property">"clean"</span><span class="token operator">:</span> <span class="token string">"theia clean"</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"theia build --mode development"</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"theia start --plugins=local-dir:plugins"</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token property">"download:plugins"</span><span class="token operator">:</span> <span class="token string">"theia download:plugins"</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该命令实际上是theia通过基于Node.js CLI构建了一个命令注册到了全局Node.js中。其在theia的源码中主要是**@theia/cli**包</p>
<h3 id="theia-cli" tabindex="-1"><a class="header-anchor" href="#theia-cli"><span>@theia/cli</span></a></h3>
<p>在@theia/cli的package.json中，通过指定bin字段来注册theia的全局命令:</p>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre v-pre><code><span class="line"><span class="token comment">// dev-packages\cli\package.json</span></span>
<span class="line"><span class="token property">"bin"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">"theia"</span><span class="token operator">:</span> <span class="token string">"./bin/theia"</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>./bin/theia 文件如下：</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token hashbang comment">#!/usr/bin/env node</span></span>
<span class="line"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/theia'</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>其入口文件指向lib/theia中，源码在src/theia.ts内，其内部有个立即执行的闭包函数</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">const</span> projectPath <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> appTarget<span class="token operator">:</span> ApplicationProps<span class="token punctuation">.</span>Target <span class="token operator">=</span> yargs<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token string">'app-target'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">{</span> projectPath<span class="token punctuation">,</span> appTarget <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> target <span class="token operator">=</span> manager<span class="token punctuation">.</span>pck<span class="token punctuation">.</span>target<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commandArgs</span><span class="token punctuation">(</span>arg<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> restIndex <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> restIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>restIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">yargs</span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  command<span class="token operator">:</span> <span class="token string">'start'</span><span class="token punctuation">,</span></span>
<span class="line">  describe<span class="token operator">:</span> <span class="token string">'start the '</span> <span class="token operator">+</span> manager<span class="token punctuation">.</span>pck<span class="token punctuation">.</span>target <span class="token operator">+</span> <span class="token string">' backend'</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">      manager<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">commandArgs</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 省略...</span></span>
<span class="line"><span class="token comment">// see https://github.com/yargs/yargs/issues/287#issuecomment-314463783</span></span>
<span class="line"><span class="token comment">// eslint-disable-next-line @typescript-eslint/no-explicit-any</span></span>
<span class="line"><span class="token keyword">const</span> commands <span class="token operator">=</span> <span class="token punctuation">(</span>yargs <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommandInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> argv <span class="token operator">=</span> yargs<span class="token punctuation">.</span><span class="token function">demandCommand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argv<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> command <span class="token operator">=</span> argv<span class="token punctuation">.</span>_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>command <span class="token operator">||</span> commands<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'non-existing or no command specified'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  yargs<span class="token punctuation">.</span><span class="token function">showHelp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">  yargs<span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>内部可以看到通过yargs来处理命令行参数并给交给ApplicationManager的start方法。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// dev-packages\application-manager\src\application-package-manager.ts</span></span>
<span class="line"><span class="token function">start</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> cp<span class="token punctuation">.</span>ChildProcess <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pck<span class="token punctuation">.</span><span class="token function">isElectron</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startElectron</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startBrowser</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token function">startElectron</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> cp<span class="token punctuation">.</span>ChildProcess <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> appPath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pck<span class="token punctuation">.</span>projectPath<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pck<span class="token punctuation">.</span>pck<span class="token punctuation">.</span>main<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            appPath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pck<span class="token punctuation">.</span><span class="token function">frontend</span><span class="token punctuation">(</span><span class="token string">'electron-main.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> mainArgs<span class="token punctuation">,</span> options <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">adjustArgs</span><span class="token punctuation">(</span><span class="token punctuation">[</span>appPath<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> electronCli <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'electron/cli.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> paths<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>pck<span class="token punctuation">.</span>projectPath<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__process<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>electronCli<span class="token punctuation">,</span> mainArgs<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">startBrowser</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> cp<span class="token punctuation">.</span>ChildProcess <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> mainArgs<span class="token punctuation">,</span> options <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">adjustArgs</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        options<span class="token punctuation">.</span>detached <span class="token operator">=</span> process<span class="token punctuation">.</span>platform <span class="token operator">!==</span> <span class="token string">'win32'</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__process<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pck<span class="token punctuation">.</span><span class="token function">backend</span><span class="token punctuation">(</span><span class="token string">'main.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mainArgs<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>start方法会根据参数类型判断当前启动的环境是browser还是electron基座。并且加载工程中的对应入口文件。注意代码的最后，<code v-pre>startBrowser</code>与<code v-pre>startElectron</code>都会调用<code v-pre>this.__process.fork</code>函数，该函数实际上是调用了node.js的cp功能衍生出了一个新的进程。以startElectron为例子，新的进程会指定启动electron的主进程执行文件(electron/cli.js)和加载前端主进程<strong>src-gen/fronted</strong>下的入口文件electron-main.js。</p>
<h3 id="src-gen-fronted" tabindex="-1"><a class="header-anchor" href="#src-gen-fronted"><span>src-gen/fronted</span></a></h3>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token comment">// examples\electron\src-gen\frontend\electron-main.js</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> application <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ElectronMainApplication<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> application<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@theia/api-samples/lib/electron-main/update/sample-updater-main-module'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>load<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Failed to start the electron application.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该文件会调用start方法，来执行ElectronMainApplication的start函数。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span>config<span class="token operator">:</span> FrontendApplicationConfig<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_config <span class="token operator">=</span> config<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hookApplicationEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_backendPort<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">whenReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachElectronSecurityToken</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startContributions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            secondInstance<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">            argv<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processArgv<span class="token punctuation">.</span><span class="token function">getProcessArgvWithoutBin</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            cwd<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token function">startBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> noBackendFork <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'--no-cluster'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">THEIA_APP_PROJECT_PATH</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globals<span class="token punctuation">.</span><span class="token constant">THEIA_APP_PROJECT_PATH</span><span class="token punctuation">;</span></span>
<span class="line">        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">THEIA_ELECTRON_VERSION</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>versions<span class="token punctuation">.</span>electron<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>noBackendFork<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            process<span class="token punctuation">.</span>env<span class="token punctuation">[</span>ElectronSecurityToken<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>electronSecurityToken<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">const</span> address<span class="token operator">:</span> AddressInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>globals<span class="token punctuation">.</span><span class="token constant">THEIA_BACKEND_MAIN_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> address<span class="token punctuation">.</span>port<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> backendProcess <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>globals<span class="token punctuation">.</span><span class="token constant">THEIA_BACKEND_MAIN_PATH</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>processArgv<span class="token punctuation">.</span><span class="token function">getProcessArgvWithoutBin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getForkOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// The backend server main file is also supposed to send the resolved http(s) server port via IPC.</span></span>
<span class="line">                backendProcess<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>address<span class="token operator">:</span> AddressInfo<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token function">resolve</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                backendProcess<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> error <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'quit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// Only issue a kill signal if the backend process is running.</span></span>
<span class="line">                    <span class="token comment">// eslint-disable-next-line no-null/no-null</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>backendProcess<span class="token punctuation">.</span>exitCode <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> backendProcess<span class="token punctuation">.</span>signalCode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token comment">// If we forked the process for the clusters, we need to manually terminate it.</span></span>
<span class="line">                            <span class="token comment">// See: https://github.com/eclipse-theia/theia/issues/835</span></span>
<span class="line">                            process<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span>backendProcess<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token comment">// See https://man7.org/linux/man-pages/man2/kill.2.html#ERRORS</span></span>
<span class="line">                            <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'ESRCH'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                                <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">                            <span class="token punctuation">}</span></span>
<span class="line">                            <span class="token keyword">throw</span> error<span class="token punctuation">;</span></span>
<span class="line">                        <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该函数会创建Electron的主进程和渲染进程实例，同时也会启动theia的backend服务。此时我们了解到，当target是electron时，除了electron的主进程和渲染进程外，其主进程还额外fork出来了一个新的进程用于加载<strong>src-gen/backend</strong>下的main.js用来启动backend服务。而根据之前的文章讲解，插件的加载一般会放在backend服务内进行，那么下面就让我们看下backend服务内是如何调度到插件加载的功能的。</p>
<h3 id="src-gen-backend" tabindex="-1"><a class="header-anchor" href="#src-gen-backend"><span>src-gen/backend</span></a></h3>
<p>这里的 main.js 的完整路径为 src-gen/backend/main.js，由 @theia/application-manager 模块中的backend-generator.ts 生成。这是 Backend 启动的入口文件。初始化时，会去调度src-gen/backend/server.js，用来进行一些依赖注入模块的绑定。同时，会调用BackendApplication的start方法，将后端应用完全启动起来。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>raw<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span></span>
<span class="line">        module <span class="token operator">=></span> container<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> argv <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>container<span class="token punctuation">.</span><span class="token function">isBound</span><span class="token punctuation">(</span>BackendApplicationServer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">container</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>BackendApplicationServer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toConstantValue</span><span class="token punctuation">(</span><span class="token punctuation">{</span> configure<span class="token operator">:</span> defaultServeStatic <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> container<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>CliManager<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initializeCli</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> container<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>BackendApplication<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> argv<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'@theia/core/lib/electron-node/keyboard/electron-backend-keyboard-module'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>load<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'@theia/core/lib/electron-node/token/electron-token-backend-module'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>load<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'@theia/core/lib/electron-node/hosting/electron-backend-hosting-module'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>load<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'@theia/plugin-ext/lib/plugin-ext-backend-electron-module'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>load<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token comment">//......省略</span></span>
<span class="line">	<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">start</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>error <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Failed to start the backend application:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        process<span class="token punctuation">.</span>exitCode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">throw</span> error<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上则是整个theia启动的过程。最后梳理的流程图如下：
<img src="@source/allmd/images/知识探索/前端/Eclipse-Thiea/C端新技术调研篇3——Theia的启动流程是什么？前后端插件子进程到底有几个？/1.png" alt="theia启动过程.png"></p>
<h3 id="基于websocket前后端建立通讯的过程" tabindex="-1"><a class="header-anchor" href="#基于websocket前后端建立通讯的过程"><span>基于websocket前后端建立通讯的过程：</span></a></h3>
<p>如上文所示，theia在启动过程中存在FrontendApplication以及BackendApplication，两者之间是如何进行通讯访问的呢？通讯的过程是如何建立的呢？在分析server.js过程中，我们发现其在对各种依赖模块的加载时，其中有一个是<code v-pre>	.then(function () { return Promise.resolve(require('@theia/plugin-ext/lib/plugin-ext-backend-electron-module')).then(load) })</code>，该模块主要用于加载和绑定后端扩展插件的模块：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// packages\plugin-ext\src\plugin-ext-backend-module.ts</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">ContainerModule</span><span class="token punctuation">(</span>bind <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">bindMainBackend</span><span class="token punctuation">(</span>bind<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">bindHostedBackend</span><span class="token punctuation">(</span>bind<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>后端插件模块分为两大类，主插件模块和三方插件模块，分别对应bindMainBackend以及bindHostedBackend。三方插件的扩展模块均在bindHostedBackend中绑定</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// packages\plugin-ext\src\hosted\node\plugin-ext-hosted-backend-module.ts</span></span>
<span class="line"><span class="token keyword">const</span> commonHostedConnectionModule <span class="token operator">=</span> ConnectionContainerModule<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> bind<span class="token punctuation">,</span> bindBackendService <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">...</span><span class="token operator">...</span>省略</span>
<span class="line">    <span class="token generic-function"><span class="token function">bindBackendService</span><span class="token generic class-name"><span class="token operator">&lt;</span>HostedPluginServer<span class="token punctuation">,</span> HostedPluginClient<span class="token operator">></span></span></span><span class="token punctuation">(</span>hostedServicePath<span class="token punctuation">,</span> HostedPluginServer<span class="token punctuation">,</span> <span class="token punctuation">(</span>server<span class="token punctuation">,</span> client<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">        server<span class="token punctuation">.</span><span class="token function">setClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        client<span class="token punctuation">.</span><span class="token function">onDidCloseConnection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> server<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> server<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">...</span><span class="token operator">...</span>省略</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">bindCommonHostedBackend</span><span class="token punctuation">(</span>bind<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Bind<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">...</span><span class="token operator">...</span>省略</span>
<span class="line">    <span class="token function">bind</span><span class="token punctuation">(</span>ConnectionContainerModule<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toConstantValue</span><span class="token punctuation">(</span>commonHostedConnectionModule<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">...</span><span class="token operator">...</span>省略</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">bindHostedBackend</span><span class="token punctuation">(</span>bind<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Bind<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">...</span><span class="token operator">...</span>省略</span>
<span class="line">    <span class="token function">bindCommonHostedBackend</span><span class="token punctuation">(</span>bind<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">...</span><span class="token operator">...</span>省略</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述的bindHostedBackend在绑定三方插件拓展模块过程中，基于inversify的<a href="https://github.com/inversify/InversifyJS/blob/master/wiki/container_api.md" target="_blank" rel="noopener noreferrer">container API</a>将后端的关键加载三方模块的逻辑进行依赖注入绑定并且进行实例化。在<code v-pre>commonHostedConnectionModule</code>的方法中，绑定了一个后端服务<code v-pre>bindBackendService</code>，这里引发了一个问题：为什么要绑定一个后端服务？原因是在于：Theia对于前端和后端通讯是基于RPC通讯的。该思想沿袭了VS Code地前后端通讯机制。VS Code当中，前后端通讯都是基于RPC来进行通讯，并且遵循了一套标准规范：<a href="https://www.jsonrpc.org/specification" target="_blank" rel="noopener noreferrer">JSON-RPC</a>规范。JSON-RPC是一个无状态且轻量级的远程过程调用(RPC)协议。 本规范主要定义了一些数据结构及其相关的处理规则。它允许运行在基于socket,http等诸多不同消息传输环境的同一进程中。其使用<a href="http://www.json.org/" target="_blank" rel="noopener noreferrer">JSON</a>（<a href="http://www.ietf.org/rfc/rfc4627.txt" target="_blank" rel="noopener noreferrer">RFC 4627</a>）作为数据格式。它地推出只有一个目的：为通讯简单而生！实际上现在有很多厂商都在遵循JSON-RPC规范来进行前后台接口调用的服务设计，例如VS Code提供的<a href="https://github.com/Microsoft/vscode-languageserver-node" target="_blank" rel="noopener noreferrer">LSP（Language server protocol Node）</a>被广泛用于定义一个插件的前后端通讯当中。Theia里的前后端RPC通讯是基于VS Code JSON-RPC的websocket版本插件：<a href="https://github.com/TypeFox/vscode-ws-jsonrpc" target="_blank" rel="noopener noreferrer">vscode-ws-jsonrpc</a>。其中前后端的RPC通讯都是基于websocket进行连接，Theia会在每一个需要前后端通讯的模块当中都会创建一条websocket通道保证双向通讯。上述<code v-pre>commonHostedConnectionModule </code>内的代码则是指定后端的一个服务来关联某个前端请求，请求服务的service-url则是：<code v-pre>hostedServicePath</code>，可以理解成java中servlet的一个path。每当客户端发送该路径的请求，则会在此进行拦截转发。同时其也绑定了一个后端服务实例<code v-pre>HostedPluginServer</code>，并且根据vscode-ws-jsonrpc的代理服务绑定了一个客户端client。那么这个client是在哪里声明且绑定的呢？让我们回到前端插件调度模块的绑定代码中：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// packages\plugin-ext\src\main\browser\plugin-ext-frontend-module.ts</span></span>
<span class="line"><span class="token function">bind</span><span class="token punctuation">(</span>HostedPluginServer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDynamicValue</span><span class="token punctuation">(</span>ctx <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> connection <span class="token operator">=</span> ctx<span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>WebSocketConnectionProvider<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> hostedWatcher <span class="token operator">=</span> ctx<span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>HostedPluginWatcher<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createProxy</span><span class="token generic class-name"><span class="token operator">&lt;</span>HostedPluginServer<span class="token operator">></span></span></span><span class="token punctuation">(</span>hostedServicePath<span class="token punctuation">,</span> hostedWatcher<span class="token punctuation">.</span><span class="token function">getHostedPluginClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inSingletonScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在前端模块加载过程中，也会创建一个<code v-pre>WebSocketConnectionProvider</code>，也就是在这儿通过<code v-pre>vscode-ws-jsonrpc</code>来创建的一条websocket通道。其会创建一个代理，用于指定当前的客户端client。并且在此通过<code v-pre>bind(HostedPluginServer)</code>绑定到一个<code v-pre>HostedPluginServer</code>实例，一旦前端功能在调用<code v-pre>HostedPluginServer</code>实例进行RPC调用后端方法时，则会触发此代理，用于调度后端的相关模块功能。后续我会专门写<a href="https://www.tapd.cn/65362886/markdown_wikis/show/#1165362886001002283" target="_blank" rel="noopener noreferrer">一篇文章</a>来详细介绍其中的细节原理。
Theia当中，服务端子插件进程的启动就是在HostedPluginServer对象中进行的，那么我们就着手从客户端调用该服务，到服务端创建一个子进程，来跟踪下整个流程。</p>
<h3 id="调用插件子进程创建流程" tabindex="-1"><a class="header-anchor" href="#调用插件子进程创建流程"><span>调用插件子进程创建流程</span></a></h3>
<p>在Theia的前端服务开始创建编辑器视图/控件时，沿袭了VS Code加载方式：基于前端插件拓展点方式依次加载插件。在第一篇文章结尾提到过，VS Code的前端插件的拓展是需要声明根据 <a href="https://code.visualstudio.com/api/references/contribution-points" target="_blank" rel="noopener noreferrer"><code v-pre>Contributes Points</code></a>来定义对于编辑器的各个模块加载的配置。每个定义的编辑器控件其本身需要继承<code v-pre>FrontendApplicationContribution</code>接口，其内部定义了控件在加载过程中的各个生命周期回调，需要在开发具体的控件中进行实现。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// packages\core\src\browser\frontend-application.ts</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">FrontendApplicationContribution</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * Called on application startup before configure is called.</span>
<span class="line">	 * 当应用启动后,configure()方法被调用前，会触发initialize生命周期方法。</span>
<span class="line">     */</span></span>
<span class="line">    initialize<span class="token operator">?</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * Called before commands, key bindings and menus are initialized.</span>
<span class="line">     * Should return a promise if it runs asynchronously.</span>
<span class="line">	 * 在命令面板初始化之前、热键绑定之前以及菜单初始化之前会被调用，如果是异步方法，则返回一个promise</span>
<span class="line">     */</span></span>
<span class="line">    configure<span class="token operator">?</span><span class="token punctuation">(</span>app<span class="token operator">:</span> FrontendApplication<span class="token punctuation">)</span><span class="token operator">:</span> MaybePromise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * Called when the application is started. The application shell is not attached yet when this method runs.</span>
<span class="line">     * Should return a promise if it runs asynchronously.</span>
<span class="line">	 * 当应用启动后会被调用。整个应用的shell窗体尚未被实例化之前将会执行这个方法。如果是异步方法，则返回一个promise</span>
<span class="line">     */</span></span>
<span class="line">    onStart<span class="token operator">?</span><span class="token punctuation">(</span>app<span class="token operator">:</span> FrontendApplication<span class="token punctuation">)</span><span class="token operator">:</span> MaybePromise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * Called on `beforeunload` event, right before the window closes.</span>
<span class="line">     * Return `true` in order to prevent exit.</span>
<span class="line">     * Note: No async code allowed, this function has to run on one tick.</span>
<span class="line">	 * 在窗口关闭前 触发beforeunload事件时被调用。</span>
<span class="line">     */</span></span>
<span class="line">    onWillStop<span class="token operator">?</span><span class="token punctuation">(</span>app<span class="token operator">:</span> FrontendApplication<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * Called when an application is stopped or unloaded.</span>
<span class="line">     *</span>
<span class="line">     * Note that this is implemented using `window.beforeunload` which doesn't allow any asynchronous code anymore.</span>
<span class="line">     * I.e. this is the last tick.</span>
<span class="line">	 *在应用停止或者Unloaded时被调用</span>
<span class="line">     */</span></span>
<span class="line">    onStop<span class="token operator">?</span><span class="token punctuation">(</span>app<span class="token operator">:</span> FrontendApplication<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * Called after the application shell has been attached in case there is no previous workbench layout state.</span>
<span class="line">     * Should return a promise if it runs asynchronously.</span>
<span class="line">	 *整个应用的shell窗体被实例化之后被调用。</span>
<span class="line">     */</span></span>
<span class="line">    initializeLayout<span class="token operator">?</span><span class="token punctuation">(</span>app<span class="token operator">:</span> FrontendApplication<span class="token punctuation">)</span><span class="token operator">:</span> MaybePromise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * An event is emitted when a layout is initialized, but before the shell is attached.</span>
<span class="line">     */</span></span>
<span class="line">    onDidInitializeLayout<span class="token operator">?</span><span class="token punctuation">(</span>app<span class="token operator">:</span> FrontendApplication<span class="token punctuation">)</span><span class="token operator">:</span> MaybePromise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在前端插件实例化过程中，通过实现<code v-pre>FrontendApplicationContribution</code>接口，的<code v-pre>onstart</code>方法，用来加载前端控件。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// packages\plugin-ext\src\hosted\browser\hosted-plugin.ts</span></span>
<span class="line"><span class="token function">onStart</span><span class="token punctuation">(</span>container<span class="token operator">:</span> interfaces<span class="token punctuation">.</span>Container<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> container<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>watcher<span class="token punctuation">.</span><span class="token function">onDidDeploy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">onDidOpenConnection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>前端控件的加载首先会去同步一下已经加载的插件id清单。</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// packages\plugin-ext\src\hosted\browser\hosted-plugin.ts</span></span>
<span class="line"><span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token function">doLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> toDisconnect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisposableCollection</span><span class="token punctuation">(</span>Disposable<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token comment">/* mark as connected */</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        toDisconnect<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Disposable<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">preserveWebviews</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">onDidCloseConnection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> toDisconnect<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// process empty plugins as well in order to properly remove stale plugin widgets</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token function">syncPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> initialized <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> syncPluginsMeasurement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createMeasurement</span><span class="token punctuation">(</span><span class="token string">'syncPlugins'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">const</span> toUnload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>contributions<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> pluginIds<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">const</span> deployedPluginIds <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">getDeployedPluginIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>syncPlugins</code>中的<code v-pre>this.server.getDeployedPluginIds();</code>方法，则是之前介绍的通过前端服务声明的一个<code v-pre>HostedPluginSupport</code>代理对象来具体对接调用后端的<code v-pre>HostedPluginServer</code>实例。也就是代码中的<code v-pre>server</code>对象。然后调用了该服务端代理对象<code v-pre>getDeployedPluginIds()</code>方法，其调度过程会基于vscode-json-rpc插件来发起websocket请求访问服务端该对象实例的<code v-pre>getDeployedPluginIds()</code>方法。让我们看看插件服务端该方法的具体实现：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// packages\plugin-ext\src\hosted\node\plugin-service.ts</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token function">getDeployedPluginIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> backendMetadata <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deployerHandler<span class="token punctuation">.</span><span class="token function">getDeployedBackendPluginIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>backendMetadata<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>hostedPlugin<span class="token punctuation">.</span><span class="token function">runPluginServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该方法在服务端会创建一个插件服务：<code v-pre>runPluginServer()</code></p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token comment">// packages\plugin-ext\src\hosted\node\hosted-plugin-process.ts</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token function">runPluginServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childProcess<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">terminatePluginServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>terminatingPluginServer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>childProcess <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            serverName<span class="token operator">:</span> <span class="token string">'hosted-plugin'</span><span class="token punctuation">,</span></span>
<span class="line">            logger<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">,</span></span>
<span class="line">            args<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>childProcess<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> message <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token constant">PLUGIN_HOST_BACKEND</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code v-pre>runPluginServer</code>当中则会通过this.fork方法来创建一个node.js的独立进程：</p>
<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre v-pre><code><span class="line"><span class="token keyword">private</span> <span class="token function">fork</span><span class="token punctuation">(</span>options<span class="token operator">:</span> IPCConnectionOptions<span class="token punctuation">)</span><span class="token operator">:</span> cp<span class="token punctuation">.</span>ChildProcess <span class="token punctuation">{</span></span>
<span class="line"><span class="token keyword">const</span> childProcess <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configuration<span class="token punctuation">.</span>path<span class="token punctuation">,</span> options<span class="token punctuation">.</span>args<span class="token punctuation">,</span> forkOptions<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">return</span> childProcess<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从而将前端插件子进程启动起来。之后，让我们通过打断点来跑一下整个流程，观察下进程数量：
<img src="@source/allmd/images/知识探索/前端/Eclipse-Thiea/C端新技术调研篇3——Theia的启动流程是什么？前后端插件子进程到底有几个？/2.png" alt="微信截图_20210928165453.png">
其中，Electron Backend：electron-cli.js是debug过程中Theia启动整个服务的主进程：
<img src="@source/allmd/images/知识探索/前端/Eclipse-Thiea/C端新技术调研篇3——Theia的启动流程是什么？前后端插件子进程到底有几个？/3.png" alt="cli.png"></p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token comment">// dev-packages\electron\electron-cli.js</span></span>
<span class="line"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'electron/cli.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>通过上述代码看到，electron-cli.js通过require了cli.js开启整个应用的启动。cli.js中首先会创建一个browser_init子进程来调用起来electron.exe（图中蓝色部分），同时指定了一个源码库中存放的一个开发示例工程<code v-pre>&quot;--app-project-path=D:\\git\\theia-1.16.0\\theia-1.16.0/examples/electron&quot;</code>，而这个开发示例工程开始，就是全文最开始所说的Theia开发工程，该工程<code v-pre>package.json</code>中指定的入口文件是：</p>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre v-pre><code><span class="line"><span class="token comment">//examples\electron\package.json</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line"><span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"src-gen/frontend/electron-main.js"</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>则开始创建Electron Frontend。之后将会按照上文分析的逻辑逐步进行前后端的模块加载，并创建插件子进程plugin-host.js。
如此通过上文，我们可以清晰地得出一个结论：Theia对于无论是前端插件还是后端插件，都是通过其后端服务(backend-service)启动一个host进程用来分别托管两套插件体系。
###总结
本文主要是从整个theia的启动流程和前后端服务通讯方式层面分析了整套插件子进程是如何创建的，且创建了几个。虽然从结论上看，theia只启动了一个子进程用来托管所有的前端插件和后端插件，但是从我们自身建设产品的需求角度，这套思路，我们也可以发散拓展，根据业务场景需要，将插件按照类型进行分类，不局限于只创建插件子进程的数量。</p>
<h3 id="参考" tabindex="-1"><a class="header-anchor" href="#参考"><span>参考</span></a></h3>
<ul>
<li><a href="https://segmentfault.com/a/1190000039327211" target="_blank" rel="noopener noreferrer">Theia 技术揭秘之 JSON-RPC 通信</a></li>
<li><a href="https://link.segmentfault.com/?url=https%3A%2F%2Ftheia-ide.org%2Fdocs%2Fjson_rpc" target="_blank" rel="noopener noreferrer">Communication via JSON-RPC</a></li>
<li><a href="https://link.segmentfault.com/?url=https%3A%2F%2Fwww.jsonrpc.org%2Fspecification" target="_blank" rel="noopener noreferrer">JSON-RPC 2.0 Specification</a></li>
<li><a href="https://link.segmentfault.com/?url=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fvscode-languageserver-node" target="_blank" rel="noopener noreferrer">microsoft/vscode-languageserver-node</a></li>
</ul>
</div></template>



"use strict";(self.webpackChunkmy_vuepress_site=self.webpackChunkmy_vuepress_site||[]).push([[122],{63836:(n,s,a)=>{a.r(s),a.d(s,{comp:()=>c,data:()=>l});var p=a(20641);const t=a.p+"assets/img/1.36055f90.png",e=a.p+"assets/img/2.61fff964.png",o={},c=(0,a(66262).A)(o,[["render",function(n,s){return(0,p.uX)(),(0,p.CE)("div",null,s[0]||(s[0]=[(0,p.Fv)('<h2 id="ä»€ä¹ˆæ˜¯rpc" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯rpc"><span>ä»€ä¹ˆæ˜¯RPCï¼Ÿ</span></a></h2><ul><li>RPCï¼ˆRemote Procedure Callï¼‰è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œç®€å•çš„ç†è§£æ˜¯ä¸€ä¸ªèŠ‚ç‚¹è¯·æ±‚å¦ä¸€ä¸ªèŠ‚ç‚¹æä¾›çš„æœåŠ¡ã€‚</li><li>æœ¬åœ°è¿‡ç¨‹è°ƒç”¨ï¼šå¦‚æœæƒ³è¦è°ƒç”¨æœ¬åœ°æŸä¸ªç±»çš„getName()æ–¹æ³•ï¼Œåˆ™åªéœ€è¦å®ç°ä¸€ä¸ªgetNameæ–¹æ³•ï¼Œå¹¶ä¸”ç›´æ¥é€šè¿‡è¿è¡Œæœ¬åœ°ç¨‹åºæ‰§è¡Œå¯¹åº”ä»£ç å³å¯ã€‚</li><li>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼šå¦‚æœgetName()æ–¹æ³•åœ¨æœåŠ¡ç«¯ï¼Œæ‰§è¡Œæ–¹æ³•çš„æ–¹æ³•ä½“åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šï¼Œå¦‚ä½•å‘Šè¯‰æœåŠ¡å™¨éœ€è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿä¸€èˆ¬æ¥è¯´ï¼š</li></ul><ol><li>é¦–å…ˆå®¢æˆ·ç«¯éœ€è¦å‘Šè¯‰æœåŠ¡å™¨ï¼Œéœ€è¦è°ƒç”¨çš„å“ªä¸ªç±»çš„å“ªä¸ªæ–¹æ³•ï¼Œè¿™é‡Œç±»å’Œæ–¹æ³•å’Œè¿›ç¨‹IDå­˜åœ¨ä¸€ä¸ªæ˜ å°„ï¼Œå®¢æˆ·ç«¯è¿œç¨‹è°ƒç”¨æ—¶ï¼Œéœ€è¦æŸ¥ä¸€ä¸‹æ–¹æ³•ï¼Œæ‰¾åˆ°å¯¹åº”çš„IDï¼Œç„¶åæ‰§è¡Œæ–¹æ³•çš„ä»£ç ã€‚</li><li>å®¢æˆ·ç«¯éœ€è¦æŠŠæœ¬åœ°å‚æ•°ä¼ ç»™è¿œç¨‹æ–¹æ³•ï¼Œæœ¬åœ°è°ƒç”¨çš„è¿‡ç¨‹ä¸­ï¼Œç›´æ¥å‹æ ˆå³å¯ï¼Œä½†æ˜¯åœ¨è¿œç¨‹è°ƒç”¨è¿‡ç¨‹ä¸­ä¸å†åŒä¸€ä¸ªå†…å­˜é‡Œï¼Œæ— æ³•ç›´æ¥ä¼ é€’æ–¹æ³•çš„å‚æ•°ï¼Œå› æ­¤éœ€è¦å®¢æˆ·ç«¯æŠŠå‚æ•°è½¬æ¢æˆå­—èŠ‚æµï¼Œä¼ ç»™æœåŠ¡ç«¯ï¼Œç„¶åæœåŠ¡ç«¯å°†å­—èŠ‚æµè½¬æ¢æˆè‡ªèº«èƒ½è¯»å–çš„æ ¼å¼ï¼Œæ˜¯ä¸€ä¸ªåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚</li><li>æ•°æ®å‡†å¤‡å¥½äº†ä¹‹åï¼Œå¦‚ä½•è¿›è¡Œä¼ è¾“ï¼Ÿç½‘ç»œä¼ è¾“å±‚éœ€è¦æŠŠè°ƒç”¨çš„IDå’Œåºåˆ—åŒ–åçš„å‚æ•°ä¼ ç»™æœåŠ¡ç«¯ï¼Œç„¶åæŠŠè®¡ç®—å¥½çš„ç»“æœåºåˆ—åŒ–ä¼ ç»™å®¢æˆ·ç«¯ï¼Œå³å¯å®Œæˆä¸€æ¬¡è°ƒç”¨è¿‡ç¨‹ã€‚</li></ol><h2 id="json-rpcå…·ä½“æœ‰å“ªäº›åº”ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#json-rpcå…·ä½“æœ‰å“ªäº›åº”ç”¨åœºæ™¯"><span>json-rpcå…·ä½“æœ‰å“ªäº›åº”ç”¨åœºæ™¯ï¼Ÿ</span></a></h2><p>vscodeå½“ä¸­å¾ˆå¤šLSPéƒ½æ˜¯åŸºäºjson-rpcè¿›è¡Œçš„ï¼Œé‚£ä¹ˆä¸ºæ­¤ï¼Œvscodeä¸“é—¨å¼€å‘äº†ä¸€å¥—json-rpcæ’ä»¶ï¼š<a href="https://www.npmjs.com/package/vscode-jsonrpc" target="_blank" rel="noopener noreferrer">vscode-jsonrpc</a>å¹¶åœ¨æ­¤åŸºç¡€ä¸Šå¼€å‘äº†åŸºäºwebsocketç‰ˆæœ¬çš„<a href="https://www.npmjs.com/package/vscode-ws-jsonrpc" target="_blank" rel="noopener noreferrer">vscode-ws-jsonrpc</a>ï¼Œæœ¬æ–‡åˆ™æ˜¯åŸºäºè¯¥æ’ä»¶è¿›è¡Œçš„ç›¸å…³æœºåˆ¶çš„å¼€å‘ã€‚</p><h2 id="å…ˆæ‹¿ä¸€ä¸ªåœºæ™¯ä¸¾ä¾‹" tabindex="-1"><a class="header-anchor" href="#å…ˆæ‹¿ä¸€ä¸ªåœºæ™¯ä¸¾ä¾‹"><span>å…ˆæ‹¿ä¸€ä¸ªåœºæ™¯ä¸¾ä¾‹ğŸŒ°ï¼š</span></a></h2><p>æœåŠ¡ç«¯æœ‰ä¸€ä¸ª<code>GetHgService</code>çš„ç±»ï¼Œé‡Œé¢æœ‰ä¸ª<code>getName()</code>æ–¹æ³•</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">GetHgService</span> <span class="token keyword">implements</span> <span class="token class-name">GetHgServer</span> <span class="token punctuation">{</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">private</span> client<span class="token operator">:</span> GetHgClient <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    getClient<span class="token operator">?</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> GetHgClient <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token function">setClient</span><span class="token punctuation">(</span>client<span class="token operator">:</span> GetHgClient<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> client</span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server-message:execute getName!&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">onDone</span><span class="token punctuation">(</span><span class="token string">&quot;hg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server-message:execute getAge!&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;32&quot;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ï¼Œå¦‚æœæƒ³è¦åœ¨å®¢æˆ·ç«¯çš„æµè§ˆå™¨é‡Œå»è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> getHgService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./frontend-application&quot;</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">getHgService<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœåŠ¡ç«¯çš„æ§åˆ¶å°ä¼šè¾“å‡ºï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">App listening on http://localhost:3155.</span>\n<span class="line">Opening channel for service path &#39;/services/search-in-workspace&#39;. [ID: 0]</span>\n<span class="line">server-message:execute getName!</span>\n<span class="line">server-message:execute getAge!</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”±äºæœåŠ¡ç«¯çš„getNameæ–¹æ³•é‡Œé¢è°ƒç”¨äº†ä¸€ä¸ªå®¢æˆ·ç«¯çš„æ–¹æ³•ï¼š<code>this.client.onDone()</code>ï¼Œæ–¹æ³•ä½“å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HGClient</span> <span class="token keyword">implements</span> <span class="token class-name">GetHgClient</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token function">onDone</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;client-message:execute onDone!&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args <span class="token operator">+</span> <span class="token string">&quot;done!&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å› æ­¤å®¢æˆ·ç«¯æµè§ˆå™¨é‡Œä¼šè¾“å‡ºï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">websocket open!</span>\n<span class="line">client-message:execute onDone!</span>\n<span class="line">hgdone!</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å“‡å“¦ï¼å®Œå…¨å°±æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æœåŠ¡ï¼Œç«Ÿç„¶å¯ä»¥åœ¨å®¢æˆ·ç«¯å°±åƒæ­£å¸¸å¼€å‘è°ƒç”¨æœ¬åœ°æ¨¡å—ä¸€æ ·è°ƒç”¨è¿œç¨‹æ¨¡å—ï¼è¿™ï¼Œå°±æ˜¯ä¸€æ•´å¥—RPCè°ƒç”¨ã€‚é‚£ä¹ˆï¼Œä¸ºäº†å®ç°è¿™ä¸ªæœºåˆ¶ï¼Œè¯¥å¦‚ä½•è®¾è®¡å‘¢ï¼Ÿæœ¬æ–‡å°†è¯¦ç»†é˜è¿°å®ç°çš„è¿‡ç¨‹ã€‚</p><h2 id="æ•´ä½“æ¶æ„" tabindex="-1"><a class="header-anchor" href="#æ•´ä½“æ¶æ„"><span>æ•´ä½“æ¶æ„ï¼š</span></a></h2><p><img src="'+t+'" alt="json-rpcæ¶æ„.png"> json-rpcæ•´ä½“è°ƒç”¨è¿‡ç¨‹è®¾è®¡å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</p><ul><li><strong>é€šè®¯å±‚</strong></li><li>é€šè®¯å±‚ä¸»è¦ä¸ºæœåŠ¡ç«¯éœ€è¦å»ºç«‹ä¸€å¥—websocketé“¾æ¥ï¼Œå»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼Œåœ¨è®¾è®¡ä¸Šï¼Œå¯ä»¥ä½¿ç”¨<code>express</code>åˆ›å»ºçš„æœåŠ¡å™¨ï¼Œå…¶æä¾›äº†å¯¹äºåè®®å‡çº§çš„èƒ½åŠ›ï¼Œå¯ä»¥æ¥æ”¶å®¢æˆ·ç«¯åœ¨å»ºç«‹è¿æ¥æ¡æ‰‹é˜¶æ®µå‘èµ·çš„websocketè¯·æ±‚ã€‚éšåï¼ŒæœåŠ¡ç«¯å¯ç”¨<code>ws</code>æ¨¡å—æ¥å¤„ç†expressçš„httpæœåŠ¡upgradeåå»ºç«‹çš„ä¸€ç³»åˆ—æœ‰å…³websocketçš„onOpenã€onMessageã€onErrorç­‰ç›‘å¬äº‹ä»¶çš„å¤„ç†ã€‚ å®¢æˆ·ç«¯éœ€è¦æŒ‡å®šæœåŠ¡ç«¯websocketçš„åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://github.com/pladaria/reconnecting-websocket" target="_blank" rel="noopener noreferrer">reconnecting-websocket</a>æ¡†æ¶ï¼Œå…¶å…¼å®¹äº†å…¨éƒ¨websocket APIæ ‡å‡†ï¼Œé«˜åº¦é…ç½®åŒ–æ–¹å¼èƒ½åŠ›ã€è·¨å¹³å°ç‰¹æ€§ã€é‡è¿æ”¯æŒé‡å®šå‘URLã€è¿æ¥åæ”¯æŒåˆ†ç‰‡ç¼“å­˜ä¼ è¾“æŠ¥æ–‡ç­‰èƒ½åŠ›å¯ä»¥è¾ƒå¥½çš„æ»¡è¶³å¯¹æ¥æœåŠ¡ç«¯websocketçš„éœ€æ±‚ã€‚</li><li><strong>ä»£ç†å±‚</strong></li><li>ä»£ç†å±‚ä¸»è¦å…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ©ç”¨å…¶ä»£ç†å·¥å‚åˆ›å»ºä»£ç†å¯¹è±¡ã€‚å¹¶ä¸”åº•å±‚ä½¿ç”¨<a href="https://github.com/TypeFox/vscode-ws-jsonrpc" target="_blank" rel="noopener noreferrer">vscode-json-rpc</a>æ¡†æ¶å¤„ç†åŸºäºwebsocketçš„json-rpcé€šè®¯æŠ¥æ–‡ã€‚ä»£ç†å±‚å¯ä»¥ä¸ºå®¢æˆ·ç«¯æä¾›ä¸€ä¸ªæœåŠ¡ç«¯çš„ä»£ç†å¯¹è±¡ï¼ˆåä¹‹äº¦ç„¶ï¼‰ï¼Œå…è®¸æœåŠ¡ç«¯åœ¨æ„å»ºä¸€ä¸ªRPCæœåŠ¡æ—¶ï¼ŒæŒ‡å®šä¸€ä¸ªæœåŠ¡çš„URLï¼Œå¹¶ä¸”å…³è”è‡ªèº«çš„ä¸€ä¸ªå®ä½“å¯¹è±¡æˆ–è€…ç±»ä»è€Œè®©å®¢æˆ·ç«¯çš„ä»£ç†å¯¹è±¡å¯ä»¥é€šè¿‡è®¿é—®è¯¥æœåŠ¡çš„URLæ¥å…³è”æœåŠ¡ç«¯çš„æŸä¸ªå®ä½“å¯¹è±¡ã€‚</li><li><strong>æ¥å£å±‚</strong></li><li>ä»£ç†å¯¹è±¡å®é™…ä¸Šå°±æ˜¯æ¥å£å±‚å®šä¹‰çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å…·ä½“æ¥å£ï¼Œå› æ­¤å…¶å±äºå…¬å…±æ¨¡å—ã€‚æœåŠ¡ç«¯å¯¹äºæ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•éœ€è¦è¿›è¡Œå…·ä½“å®ç°ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯ä»£ç†å¯¹è±¡è¿›è¡Œè°ƒç”¨(åä¹‹äº¦ç„¶)ã€‚</li><li><strong>æœåŠ¡å±‚</strong></li><li>æœåŠ¡å±‚ä¸»è¦æ˜¯é’ˆå¯¹æ¥å£å±‚è¿›è¡Œå…·ä½“çš„å®ç°ï¼Œä»è€Œå®¢æˆ·ç«¯ä»£ç†å¯¹è±¡å®é™…ä¸Šæ˜¯è°ƒç”¨æ¥å£ï¼ŒæœåŠ¡ç«¯çš„å…·ä½“æœåŠ¡çš„å®ç°ç±»ä¼šå¯¹æ¥å£è¿›è¡Œå®ç°ï¼ˆåä¹‹äº¦ç„¶ï¼‰ã€‚</li><li><strong>è°ƒç”¨å±‚</strong></li><li>è°ƒåº¦å±‚é¢ï¼Œå®¢æˆ·ç«¯éœ€è¦åˆ›å»ºæœåŠ¡ç«¯çš„ä»£ç†å¯¹è±¡ï¼Œå¦‚æœæœåŠ¡ç«¯ä¹Ÿä¼šåå‘è°ƒç”¨å®¢æˆ·ç«¯çš„æŸäº›æ–¹æ³•ï¼Œé‚£ä¹ˆä¹Ÿè¦å°†è‡ªèº«çš„å®¢æˆ·ç«¯ä»£ç†å¯¹è±¡æ¥å£ä¼ é€’ç»™æœåŠ¡ç«¯ã€‚è€ŒæœåŠ¡ç«¯åˆ™éœ€è¦åœ¨è°ƒåº¦å±‚ç»‘å®šå¥½å¯¹åº”çš„å®ç°ç±»ï¼Œä»¥åº”å¯¹å®¢æˆ·ç«¯å‘èµ·çš„RPCè¯·æ±‚è¿›è¡Œå…·ä½“å®ç°ç±»çš„åˆ†å‘ã€‚ ##è¯¦ç»†è®¾è®¡ï¼š é¦–å…ˆï¼Œåœ¨é€šè®¯å±‚ï¼Œexpressä¼šåˆ›å»ºä¸€ä¸ªserveræœåŠ¡ï¼š</li></ul><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">//json-rpc-learn\\src\\server\\backend-application.ts</span></span>\n<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BackendApplication</span> <span class="token punctuation">{</span></span>\n<span class="line"><span class="token keyword">protected</span> <span class="token keyword">readonly</span> app<span class="token operator">:</span> express<span class="token punctuation">.</span>Application <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span>aPort<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> aHostname<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>http<span class="token punctuation">.</span>Server <span class="token operator">|</span> https<span class="token punctuation">.</span>Server<span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">\tserver <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token keyword">new</span> <span class="token class-name">MessagingContribution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>onStart<span class="token operator">!</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°è¿‡ç¨‹æ˜¯å°†expressåˆ›å»ºçš„serveræœåŠ¡ä¼ é€’ç»™MessagingContibutionç±»ï¼Œè¯¥ç±»ç”¨äºè¿›è¡Œå¯¹äºhttpæœåŠ¡upgradeåç»‘å®šwsè¿›è¡Œwebsocketå¤„ç†çš„å…³é”®åŠŸèƒ½ã€‚ é¦–å…ˆï¼Œåˆå§‹åŒ–ä¹æ„æ­ŒMessagingContibutionå®ä¾‹ã€‚è¯¥å®ä¾‹çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">//json-rpc-learn\\src\\server\\messaging-contribution.ts</span></span>\n<span class="line"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ws</span><span class="token punctuation">(</span>WebSocketChannel<span class="token punctuation">.</span>wsPath<span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> socket<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleChannels</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"><span class="token function">ws</span><span class="token punctuation">(</span>spec<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span>params<span class="token operator">:</span> MessagingService<span class="token punctuation">.</span>PathParams<span class="token punctuation">,</span> socket<span class="token operator">:</span> ws<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>wsHandlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>spec<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå®åŠ›çš„æ„é€ å‡½æ•°é‡Œï¼Œè°ƒç”¨äº†wsæ–¹æ³•ã€‚å¹¶ä¸”æŒ‡å®šäº†ä¸€ä¸ªwebsocketæœåŠ¡çš„æ ¹æœåŠ¡åœ°å€ï¼Œæ¯”å¦‚æœ¬æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥ç»™è¿™ä¸ªwsPathèµ‹å€¼ä¸º<code>/service</code>ï¼Œåˆ™å®¢æˆ·ç«¯å»ºç«‹è¿æ¥æ—¶ï¼Œéœ€è¦è®¿é—®<code>ws://X.X.X.X:XXXX/service</code>ã€‚åŒæ—¶ï¼Œwsæ–¹æ³•è¿˜éœ€è¦ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°<code>(_,socket)=&gt;this.handleChannels(socket)</code>ã€‚ä¹Ÿå°±æ˜¯è¯´wsä¼šåœ¨æŸä¸€æ—¶æœºï¼Œè§¦å‘this.handleChannels(socket)çš„æ–¹æ³•ã€‚è‡³äºæ˜¯ä»€ä¹ˆæ—¶æœºï¼Œæˆ‘ä»¬å†é€æ­¥å¾€ä¸‹åˆ†æã€‚</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">//json-rpc-learn\\src\\server\\messaging-contribution.ts</span></span>\n<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MessagingContribution</span> <span class="token punctuation">{</span></span>\n<span class="line"><span class="token operator">...</span> <span class="token operator">...</span></span>\n<span class="line"><span class="token function">onStart</span><span class="token punctuation">(</span>server<span class="token operator">:</span> http<span class="token punctuation">.</span>Server <span class="token operator">|</span> https<span class="token punctuation">.</span>Server<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>webSocketServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ws</span><span class="token punctuation">.</span><span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>\n<span class="line">            noServer<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>\n<span class="line">            perMessageDeflate<span class="token operator">:</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token comment">// don&#39;t compress if a message is less than 256kb</span></span>\n<span class="line">                threshold<span class="token operator">:</span> <span class="token number">256</span> <span class="token operator">*</span> <span class="token number">1024</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;upgrade&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleHttpUpgrade</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token operator">...</span> <span class="token operator">...</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨serveræ¥æ”¶åˆ°upgradeè¯·æ±‚åï¼ŒMessagingContributionä¼šåˆ†å‘ç»™<code>handleHttpUpgrade</code>æ–¹æ³•è¿›è¡Œå¤„ç†ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">//json-rpc-learn\\src\\server\\messaging-contribution.ts</span></span>\n<span class="line"><span class="token keyword">protected</span> <span class="token function">handleHttpUpgrade</span><span class="token punctuation">(</span>request<span class="token operator">:</span> http<span class="token punctuation">.</span>IncomingMessage<span class="token punctuation">,</span> socket<span class="token operator">:</span> net<span class="token punctuation">.</span>Socket<span class="token punctuation">,</span> head<span class="token operator">:</span> Buffer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>webSocketServer<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">handleUpgrade</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> head<span class="token punctuation">,</span> client <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>webSocketServer<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;connection&#39;</span><span class="token punctuation">,</span> client<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                <span class="token comment">// this.messagingListener.onDidWebSocketUpgrade(request, client); //å½“ç›‘å¬åˆ°æœ‰upgradeæ“ä½œæ—¶ï¼Œä¼šè§¦å‘æŸäº›ç›‘å¬å™¨çš„å›è°ƒ</span></span>\n<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;HTTP/1.1 500 Internal Error\\n\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            socket<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨<code>handleHttpUpgrade</code>æ–¹æ³•ä¸­ï¼Œwsæ¨¡å—ä¼šæŠ›å‡ºä¸€ä¸ªconnectionäº‹ä»¶ï¼Œè€Œwsåœ¨å»ºç«‹è¿æ¥æ—¶ï¼Œä¹Ÿå¯¹connectionäº‹ä»¶è¿›è¡Œäº†ç›‘å¬ï¼Œåˆ™è§¦å‘äº†åç»­å»ºç«‹é“¾æ¥çš„é€»è¾‘ã€‚</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token function">onStart</span><span class="token punctuation">(</span>server<span class="token operator">:</span> http<span class="token punctuation">.</span>Server <span class="token operator">|</span> https<span class="token punctuation">.</span>Server<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line"><span class="token operator">...</span> <span class="token operator">...</span></span>\n<span class="line">\t<span class="token keyword">this</span><span class="token punctuation">.</span>webSocketServer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connection&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>socket<span class="token operator">:</span> CheckAliveWS<span class="token punctuation">,</span> request<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\tsocket<span class="token punctuation">.</span>alive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t\tsocket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;pong&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> socket<span class="token punctuation">.</span>alive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t\t<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleConnection</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token operator">...</span> <span class="token operator">...</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è€Œåœ¨connectionçš„ç›‘å¬é‡Œï¼Œä¼šåˆ†å‘ç»™handleConnectionæ–¹æ³•ï¼Œåç»­å°†ä¼šå¯¹è¿™ä¸€æ–¹æ³•åœ¨è°ƒåº¦å±‚çš„è®²è§£ä¸­è¯¦ç»†ä»‹ç»ã€‚è®©æˆ‘ä»¬å†å›åˆ°é€šè®¯å±‚çš„å®¢æˆ·ç«¯è§’åº¦ï¼Œçœ‹çœ‹éƒ½åšäº†ä»€ä¹ˆã€‚é¦–å…ˆï¼Œå®¢æˆ·ç«¯ä¼šå»ºç«‹ä¸æœåŠ¡ç«¯çš„websocketè¿æ¥ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">//json-rpc-learn\\src\\client\\ws-connection-provider.ts</span></span>\n<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketConnectionProvider</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractConnectionProvider<span class="token operator">&lt;</span>WebSocketOptions<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token function">constructor</span><span class="token punctuation">(</span>port<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t<span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span></span>\n<span class="line">\t\t\t<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createWebSocketUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/services&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t<span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createWebSocket</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨åˆ›å»ºä¸æœåŠ¡ç«¯çš„websocketé“¾æ¥æ—¶ï¼Œä½¿ç”¨äº†<code>reconnecting-websocket</code>æ¡†æ¶ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// json-rpc-learn\\src\\client\\ws-connection-provider.ts</span></span>\n<span class="line"><span class="token keyword">protected</span> <span class="token function">createWebSocket</span><span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> ReconnectingWebSocket <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReconnectingWebSocket</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>\n<span class="line">            WebSocket<span class="token operator">:</span> <span class="token constant">WS</span><span class="token punctuation">,</span></span>\n<span class="line">            maxReconnectionDelay<span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span></span>\n<span class="line">            minReconnectionDelay<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span></span>\n<span class="line">            reconnectionDelayGrowFactor<span class="token operator">:</span> <span class="token number">1.3</span><span class="token punctuation">,</span></span>\n<span class="line">            connectionTimeout<span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span></span>\n<span class="line">            maxRetries<span class="token operator">:</span> <span class="token number">Infinity</span><span class="token punctuation">,</span></span>\n<span class="line">            debug<span class="token operator">:</span> <span class="token boolean">false</span></span>\n<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”±æ­¤ï¼Œå®¢æˆ·ç«¯ä¾¿å¯ä»¥ä¸æœåŠ¡ç«¯å»ºç«‹é“¾æ¥äº†ã€‚ æ¥ä¸‹æ¥ï¼Œåœ¨ä»£ç†å±‚ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆä»ä¸Šæ–‡é€šè®¯å±‚å…¥æ‰‹ï¼Œé€šè®¯å±‚æœåŠ¡ç«¯<code>ws</code>æ¨¡å—åœ¨<code>connection</code>çš„ç›‘å¬é‡Œï¼Œä¼šåˆ†å‘ç»™<code>handleConnection</code>æ–¹æ³•ï¼Œè¿™é‡Œé¢å…·ä½“åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ ç”±äºæ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯é€šè¿‡ä¸€ä¸ª<code>websocket</code>é€šé“è¿›è¡Œåˆ†å‘ï¼Œé‚£ä¹ˆä¸ºäº†åŒºåˆ†å„ä¸ªæœåŠ¡è¯·æ±‚ï¼Œåˆ™åœ¨<code>url</code>ä¸­éœ€è¦ä¾æ®åé¢çš„æœåŠ¡åæ¥åŒºåˆ†è°ƒåº¦ä¸åŒçš„æœåŠ¡è¿›è¡Œå¤„ç†ã€‚æ¯”å¦‚ï¼Œå½“æˆ‘ä»¬å‘é€<code>ws://127.0.0.1:8001/service/crownhuang</code>ï¼Œåˆ™å¯ä»¥åœ¨æ­¤é€šè¿‡åˆ¤æ–­æœåŠ¡è·¯å¾„æ¥åˆ†å‘ç»™å…·ä½“çš„<code>/services/crownhuang</code>æœåŠ¡æ¥å¤„ç†ï¼Œå¾ˆç±»ä¼¼springmvcä¸­çš„serviceåˆ†å‘æœºåˆ¶ã€‚<code>handleConnection</code>ä¸»è¦å°±æ˜¯ç”¨æ¥æ ¹æ®è¯·æ±‚çš„urlè·¯ç”±è·¯å¾„è¿›è¡ŒæœåŠ¡åˆ†å‘ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// json-rpc-learn\\src\\server\\messaging-contribution.ts</span></span>\n<span class="line"><span class="token keyword">protected</span> <span class="token function">handleConnection</span><span class="token punctuation">(</span>socket<span class="token operator">:</span> ws<span class="token punctuation">,</span> request<span class="token operator">:</span> http<span class="token punctuation">.</span>IncomingMessage<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">const</span> pathname <span class="token operator">=</span> request<span class="token punctuation">.</span>url <span class="token operator">&amp;&amp;</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>pathname<span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>pathname <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>wsHandlers<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;Cannot find a ws handler for the path: &#39;</span> <span class="token operator">+</span> pathname<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ–¹æ³•ä¼šæ ¹æ®ä¼ å…¥<code>request</code>è¯·æ±‚çš„<code>url</code>ä»<code>wsHandler</code>æ•°ç»„é‡Œé¢å–å‡ºæ¥è½¬å‘ç»™å…·ä½“å¤„ç†çš„æœåŠ¡ã€‚ä¸Šæ–‡è¯´åˆ°ï¼Œåœ¨<code>MessagingContribution</code>çš„æ„é€ å‡½æ•°ä¸­ï¼Œä¼šå¾€wsHandleré‡Œå­˜å…¥wsPathï¼Œä¹Ÿå°±æ˜¯<code>/services</code>ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ä¸€çº§è·¯ç”±ã€‚wsHandleræ•´ä½“ä¼šæ ¹æ®ä¸åŒçš„ä¸€çº§è·¯ç”±åç§°æ¥å­˜å‚¨å¾ˆå¤šæœåŠ¡å¤„ç†çš„å›è°ƒã€‚åŒæ—¶ï¼Œwsæ–¹æ³•è¿˜éœ€è¦ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°<code>(_,socket)=&gt;this.handleChannels(socket)</code>ã€‚é‚£ä¹ˆï¼Œå½“å®¢æˆ·ç«¯è®¿é—®<code>ws://x.x.x.x:xxxx/services</code>ï¼Œåœ¨æ¡æ‰‹å»ºç«‹è¿æ¥é˜¶æ®µï¼ŒæœåŠ¡ç«¯è§¦å‘<code>route</code>æ–¹æ³•æ—¶ï¼Œå…¶ä¼šæ ¹æ®æ­¤æ¬¡<code>service</code>æœåŠ¡çš„ä¸€çº§è·¯ç”±é¦–å…ˆè§¦å‘åˆ°å¯¹åº”çš„å›è°ƒå‡½æ•°<code>(_,socket)=&gt;this.handleChannels(socket)</code>ï¼Œå¹¶ä¸”æŠŠå½“å‰çš„socketé“¾æ¥ä¼ ç»™<code>this.handleChannels</code>é‡Œã€‚<code>route</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// json-rpc-learn\\src\\server\\messaging-contribution.ts</span></span>\n<span class="line"><span class="token function">route</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> connection<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token boolean">false</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> handler <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">                    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">handler</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                        <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>\n<span class="line">                    <span class="token punctuation">}</span></span>\n<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±ç»§ç»­åˆ†æ<code>this.handleChannels(socket)</code>æ–¹æ³•çš„åŠŸèƒ½ã€‚</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// json-rpc-learn\\src\\server\\messaging-contribution.ts</span></span>\n<span class="line"><span class="token keyword">protected</span> <span class="token function">handleChannels</span><span class="token punctuation">(</span>socket<span class="token operator">:</span> ws<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">const</span> channelHandlers <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConnectionChannelHandlers</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">const</span> channels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">,</span> WebSocketChannel<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token keyword">const</span> message<span class="token operator">:</span> WebSocketChannel<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">&#39;open&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                    <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> message<span class="token punctuation">;</span></span>\n<span class="line">                    <span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>channelHandlers<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                        channel<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Opening channel for service path &#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#39;. [ID: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                        channels<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                        channel<span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">                            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Closing channel on service path &#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#39;. [ID: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                            channels<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>\n<span class="line">                        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;Cannot find a service for the path: &#39;</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                    <span class="token punctuation">}</span></span>\n<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>\n<span class="line">                    <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> message<span class="token punctuation">;</span></span>\n<span class="line">                    <span class="token keyword">const</span> channel <span class="token operator">=</span> channels<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                        channel<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>\n<span class="line">                        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;The ws channel does not exist&#39;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                    <span class="token punctuation">}</span></span>\n<span class="line">                <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;Failed to handle message&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> error<span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">//...... çœç•¥</span></span>\n<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;close&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>code<span class="token punctuation">,</span> reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">//...... çœç•¥</span></span>\n<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆï¼Œä»å¤§æ¡†ä¸Šçœ‹ï¼Œä¸»è¦æ˜¯å¯¹äºä¼ å…¥çš„socketé“¾æ¥è¿›è¡Œç›¸å…³ç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„å¤„ç†ã€‚ä½†æ˜¯æœ€å¼€å§‹çš„ä¸€æ®µä»£ç ï¼Œè°ƒç”¨äº†ä¸€ä¸‹<code>this.getConnectionChannelHandlers(socket);</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// json-rpc-learn\\src\\server\\messaging-contribution.ts</span></span>\n<span class="line"><span class="token keyword">protected</span> <span class="token function">getConnectionChannelHandlers</span><span class="token punctuation">(</span>socket<span class="token operator">:</span> ws<span class="token punctuation">)</span><span class="token operator">:</span> MessagingContribution<span class="token punctuation">.</span>ConnectionHandlers<span class="token operator">&lt;</span>WebSocketChannel<span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">const</span> connectionChannelHandlers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessagingContribution</span><span class="token punctuation">.</span><span class="token function">ConnectionHandlers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>channelHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        connectionChannelHandlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>HgServiceConnectionhandler<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> channel<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token function">createWebSocketConnection</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConsoleLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            HgServiceConnectionhandler<span class="token punctuation">.</span><span class="token function">onConnection</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">return</span> connectionChannelHandlers<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç æœ‰äº›æ™¦æ¶©éš¾æ‡‚ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆç†Ÿæ‚‰çš„åœ°æ–¹ï¼Œåˆ™æ˜¯åœ¨è¯¥æ–¹æ³•å†…ï¼Œåˆnewäº†ä¸€ä¸ªconnectionHandlerå®ä¾‹ï¼Œè¿™ä¸åˆšå¼€å§‹è®²åˆ°çš„wsHanlderçš„å®ä¾‹ï¼š<code>protected readonly channelHandlers = new MessagingContribution.ConnectionHandlers&lt;WebSocketChannel&gt;();</code>å±äºç»Ÿä¸€ç±»ï¼Œé‚£ä¹ˆä¸¤è€…çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿé€šè¿‡ä»£ç çœ‹åˆ°ï¼Œåœ¨è¿™æ¬¡çš„pushæ–¹æ³•ä¸­ï¼Œä¼ å…¥çš„æ˜¯HgServiceConnectionhandler.pathï¼Œå…¶å…·ä½“ä¸º<code>export const HG_WS_PATH = &#39;/services/hg-service&#39;;</code>ï¼ŒåŸæ¥ï¼Œåœ¨ä¸€çº§è·¯ç”±çš„å›è°ƒé‡Œï¼Œæˆ‘ä»¬åˆé’ˆå¯¹äºäºŒçº§è·¯ç”±è¿›è¡Œäº†å›è°ƒçš„ç»‘å®šï¼Œä¸€ä¸ªä¸€çº§è·¯ç”±ä¸‹åˆ™ä¹Ÿå¯ä»¥å…è®¸ç»‘å®šå¤šä¸ªäºŒçº§è·¯ç”±ï¼Œä¸Šè¿°ä»£ç é‡Œåˆ™æŒ‡ç»‘å®šäº†ä¸€ä¸ªHgServiceçš„äºŒçº§è·¯ç”±ï¼Œå¦‚æœåç»­æœ‰å¤šä¸ªäºŒçº§è·¯ç”±ï¼Œåˆ™éƒ½éœ€è¦åœ¨æ­¤æ–¹æ³•é‡Œè¿›è¡Œç»‘å®šã€‚é‚£ä¹ˆä¸€æ—¦å®¢æˆ·ç«¯å»ºç«‹é“¾æ¥è®¿é—®äº†<code>ws://x.x.x.x:xxxx/service/hg-service</code>ï¼Œåˆ™ä¼šè§¦å‘ä¸Šè¿°ä»£ç å—ä¸­çš„<code>(_,channel)={}</code>å›è°ƒå‡½æ•°éƒ¨åˆ†ã€‚ å…¶ä¼šæ ¹æ®äºŒçº§è·¯ç”±åœ°å€ï¼Œéå†<code>channelHandlers</code>æ•°ç»„ï¼Œçœ‹æ˜¯å¦æœ‰åŒ¹é…çš„æœåŠ¡ç”¨äºå¤„ç†è¯¥è¯·æ±‚ã€‚<code>channelHandlers</code>æ•°ç»„åˆ™æ˜¯åœ¨å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ä¸­å°†ä¸åŒçš„æœåŠ¡å®ä¾‹ä¼ å…¥è¿›å»çš„ã€‚æ¯”å¦‚ï¼Œä¸Šè¿°ä»£ç æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª<code>HgService</code>çš„æœåŠ¡ï¼Œå°†å®ä¾‹çš„è·¯å¾„(<code>HgServiceConnectionhandler.path</code>)å’Œç›‘å¬åˆ°å·²ç»å»ºç«‹é“¾æ¥çš„å¤„ç†æ–¹æ³•(<code>(_,channel)=&gt;{...}</code>)é€šè¿‡ä¸Šé¢çš„ä»£ç ä¼ å…¥åˆ°<code>channelHandlers</code>å½“ä¸­ã€‚ åœ¨æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œå…ˆæ ¹æ®æ¶ˆæ¯<code>kind</code>åˆ¤æ–­æ˜¯ç¬¬ä¸€æ¬¡æ‰“å¼€è¿˜æ˜¯å·²ç»æ‰“å¼€ï¼Œå¦‚æœæ˜¯<code>open</code>ï¼Œåˆ™é€šè¿‡<code>path</code>åˆ¤æ–­æ˜¯å¦åœ¨<code>channelHandlers</code>ä¸­å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯æ˜¯å¦æ³¨å†Œè¿‡ï¼Œå¦‚ï¼š<code>new JsonRpcConnectionHandler&lt;GetHgClient&gt;(&quot;/services/hg-service&quot;, client =&gt; {</code>ï¼Œå…¶ä¸­<code>path</code>ä¸º<code>&quot;/services/hg-service&quot;</code>ï¼Œå¦‚æœæ³¨å†Œè¿‡åˆ™é€šè¿‡å”¯ä¸€çš„<code>id</code>ä¿å­˜åˆ°å«åš<code>channels</code>çš„<code>Map</code>ä¸­ï¼›å¦‚æœé<code>open</code>ï¼Œåˆ™ä»<code>Map</code>ä¸­è·å–å¯¹åº”çš„<code>channel</code>å¹¶è°ƒç”¨å…¶<code>handleMessage</code>æ–¹æ³•è¿›è¡Œæ¶ˆæ¯å¤„ç†ã€‚</p><blockquote><p>å…¶ä¸­<code>id</code>ä¸º<code>vscode-ws-jsonrpc</code>åŒ…ç”Ÿæˆçš„æ•°æ®æ ¼å¼ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œåœ¨<code>open</code>æ—¶å¹¶éJSON-RPCï¼Œè€Œåœ¨é<code>open</code>æ—¶çš„<code>message</code>åˆ™ä¸ºJSON-RPCæ ¼å¼çš„æ•°æ®ï¼ŒåŒæ ·ç”±<code>vscode-ws-jsonrpc</code>ç”Ÿæˆã€‚</p></blockquote><blockquote><p>æœ‰å…³<code>channel</code>çš„å†…å®¹ä¼šåœ¨åæ–‡æåˆ°ã€‚</p></blockquote><h4 id="åç«¯å¦‚ä½•å¤„ç†æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#åç«¯å¦‚ä½•å¤„ç†æ¶ˆæ¯"><span>åç«¯å¦‚ä½•å¤„ç†æ¶ˆæ¯</span></a></h4><p>åœ¨çœ‹åç«¯å¦‚ä½•å¤„ç†æ¶ˆæ¯å‰ï¼Œéœ€è¦å…ˆäº†è§£<code>channel</code>æ˜¯ä»€ä¹ˆï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„ä»£ç åˆ‡å…¥ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸€ä¸ª<code>channel</code>ï¼Œå®ç°å…¥ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">protected</span> <span class="token function">createChannel</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> socket<span class="token operator">:</span> ws<span class="token punctuation">)</span><span class="token operator">:</span> WebSocketChannel <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketChannel</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> content <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>socket<span class="token punctuation">.</span>readyState <span class="token operator">&lt;</span> ws<span class="token punctuation">.</span><span class="token constant">CLOSING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                    <span class="token keyword">throw</span> err<span class="token punctuation">;</span></span>\n<span class="line">                <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæˆ‘ä»¬å‘ç°è¿™ä¸ª<code>channel</code>å®é™…ä¸Šæ˜¯ä¸€ä¸ª<code>WebSocketChannel</code>ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹<code>WebSocketChannel</code>çš„ä»£ç ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketChannel</span> <span class="token keyword">implements</span> <span class="token class-name">IWebSocket</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">static</span> wsPath <span class="token operator">=</span> <span class="token string">&#39;/services&#39;</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line">\t<span class="token function">constructor</span><span class="token punctuation">(</span></span>\n<span class="line">        <span class="token keyword">readonly</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span></span>\n<span class="line">        <span class="token keyword">protected</span> <span class="token keyword">readonly</span> <span class="token function-variable function">doSend</span><span class="token operator">:</span> <span class="token punctuation">(</span>content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span>\n<span class="line">    <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line">\t<span class="token function">handleMessage</span><span class="token punctuation">(</span>message<span class="token operator">:</span> WebSocketChannel<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">&#39;ready&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fireOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fireMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">&#39;close&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fireClose</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>code<span class="token punctuation">,</span> message<span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token function">open</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkNotDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doSend</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>WebSocketChannel<span class="token punctuation">.</span>OpenMessage<span class="token operator">&gt;</span><span class="token punctuation">{</span></span>\n<span class="line">            kind<span class="token operator">:</span> <span class="token string">&#39;open&#39;</span><span class="token punctuation">,</span></span>\n<span class="line">            id<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>\n<span class="line">            path</span>\n<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkNotDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doSend</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>WebSocketChannel<span class="token punctuation">.</span>ReadyMessage<span class="token operator">&gt;</span><span class="token punctuation">{</span></span>\n<span class="line">            kind<span class="token operator">:</span> <span class="token string">&#39;ready&#39;</span><span class="token punctuation">,</span></span>\n<span class="line">            id<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id</span>\n<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token function">send</span><span class="token punctuation">(</span>content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkNotDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doSend</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>WebSocketChannel<span class="token punctuation">.</span>DataMessage<span class="token operator">&gt;</span><span class="token punctuation">{</span></span>\n<span class="line">            kind<span class="token operator">:</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span></span>\n<span class="line">            id<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>\n<span class="line">            content</span>\n<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line">\t<span class="token keyword">protected</span> <span class="token function-variable function">fireOpen</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function-variable function">void</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token function-variable function">cb</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkNotDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>fireOpen <span class="token operator">=</span> cb<span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>toDispose<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Disposable<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">fireOpen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">protected</span> <span class="token function-variable function">fireMessage</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function-variable function">void</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token function-variable function">cb</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkNotDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>fireMessage <span class="token operator">=</span> cb<span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>toDispose<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Disposable<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">fireMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ç€å›åˆ°ä¸Šé¢å¤„ç†æ¶ˆæ¯çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line">channel<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>è¡¨ç¤ºåœ¨æ¥åˆ°æ¶ˆæ¯åä¼ é€’ç»™äº†<code>channel</code>çš„<code>handleMessage</code>æ–¹æ³•å¤„ç†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡<code>WebSocketChannel</code>æ‰¾åˆ°å¤„ç†å‡½æ•°çš„å®ç°ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹å¤„ç†JSON-RPCæ¶ˆæ¯çš„éƒ¨åˆ†ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fireMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†æ˜¯å´æ²¡åœ¨å·¥ç¨‹ä¸­æ‰¾åˆ°<code>fireMessage</code>æ–¹æ³•çš„å®šä¹‰ï¼Œå…¶å®è¿™ä¸ªæ–¹æ³•å¯ä»¥é€šè¿‡<code>channel</code>çš„<code>onMessage</code>æ–¹æ³•è¿›è¡Œèµ‹å€¼ï¼Œè¿™é‡Œåœ¨<code>vscode-ws-jsonrpc</code>ä¼šæœ‰ä¸€æ¬¡èµ‹å€¼ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">//vscode-ws-jsonrpc/src/socket/reader.ts</span></span>\n<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketMessageReader</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMessageReader</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line">\t<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">protected</span> <span class="token keyword">readonly</span> socket<span class="token operator">:</span> IWebSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span>message <span class="token operator">=&gt;</span></span>\n<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span></span>\n<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token comment">// ...</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line">\t<span class="token keyword">protected</span> <span class="token function">readMessage</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">&#39;initial&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">&#39;listening&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>callback<span class="token operator">!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€ç»ˆé€šè¿‡<code>vscode-jsonrpc</code>ä¼šè§¦å‘ä¸Šæ–‡ä»£ç å—ï¼Œä½•æ—¶è§¦å‘å‘¢ï¼Ÿå°±æ˜¯å½“æ¥æ”¶åˆ°è¯·æ±‚ï¼Œè§¦å‘<code>fireMessage</code>æ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„åˆ™æ˜¯vscode-ws-jsonrpcæ’ä»¶ä¸­readerç±»çš„<code>readMessage</code>çš„æ–¹æ³•ã€‚<code>readMessage</code>é‡Œè°ƒç”¨äº†<code>this.callback!(data)</code>ï¼Œå®é™…ä¸Šæ˜¯åœ¨ä¸‹æ–‡<code>JsonRpcProxyFactory</code>ä¸­è°ƒç”¨listenæ–¹æ³•æ—¶ï¼Œæ‰§è¡Œ<code>connection.listen();</code>ç»‘å®šçš„<code>callback</code>ï¼Œé‚£ä¹ˆè¿™ä¸ª<code>listen</code>æ–¹æ³•ä¸»è¦å…³è”äº†ä»€ä¹ˆå‘¢ï¼Ÿvscode-jsonrpcå†…éƒ¨æŒ‡å®šäº†ä¸€ç³»åˆ—çš„æ¶ˆæ¯ç±»å‹ï¼Œ<code>Request</code>ï¼Œ<code>Notification</code>ï¼Œ<code>Disposable</code>ç­‰ï¼Œåœ¨<code>JsonRpcProxyFactory</code>ä¸­å¯¹äºè¿™äº›æ¶ˆæ¯ç±»å‹çš„å“åº”å‡½æ•°å¤„ç†ï¼Œåˆ™æ˜¯åœ¨listenæ–¹æ³•ä¸­è¿›è¡Œçš„ã€‚è¯¦ç»†ä»£ç è§ä¸‹æ–‡ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// json-rpc-learn\\src\\server\\messaging-contribution.ts</span></span>\n<span class="line">connectionChannelHandlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>HgServiceConnectionhandler<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> channel<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token function">createWebSocketConnection</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConsoleLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            HgServiceConnectionhandler<span class="token punctuation">.</span><span class="token function">onConnection</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span class="token comment">//</span></span>\n<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JsonRpcConnectionHandler<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> object<span class="token operator">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ConnectionHandler</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span></span>\n<span class="line">\t<span class="token operator">...</span> <span class="token operator">...</span></span>\n<span class="line">    <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token function">onConnection</span><span class="token punctuation">(</span>connection<span class="token operator">:</span> MessageConnection<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token keyword">this</span></span><span class="token punctuation">.</span><span class="token function">factoryConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">const</span> proxy <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        factory<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">targetFactory</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        factory<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JsonRpcProxyFactory<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> object<span class="token operator">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ProxyHandler<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token function">listen</span><span class="token punctuation">(</span>connection<span class="token operator">:</span> MessageConnection<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\tconnection<span class="token punctuation">.</span><span class="token function">onRequest</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onRequest</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\tconnection<span class="token punctuation">.</span><span class="token function">onNotification</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onNotification</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\tconnection<span class="token punctuation">.</span><span class="token function">onDispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\tconnection<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connectionPromiseResolve</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‚£ä¹ˆï¼Œä¸€æ—¦ç»‘å®šå¥½listenï¼Œå…¶å®å°±å°†æœåŠ¡ç«¯åº”ç”¨å±‚å®ç°çš„å¤„ç†å„ç§è¯·æ±‚ã€é€šçŸ¥ã€é”€æ¯çš„å›è°ƒå‡½æ•°å®ç°ä¸vscode-ws-jsonrpcå…³è”å®Œæˆäº†ï¼Œä¸€æ—¦æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ï¼Œåˆ™ä¼šè§¦å‘callbackï¼Œå¹¶ä¸”vscode-ws-jsonrpcä¼šå°†æ‰€æœ‰å¤„ç†çš„è¯·æ±‚æ”¾ç½®åœ¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œé€æ­¥æ ¹æ®è¯·æ±‚ç±»å‹æ¥è§¦å‘åº”ç”¨å±‚çš„å›è°ƒå‡½æ•°ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å°†è¯¦ç»†ä»‹ç»æ•´ä¸ªå‰åç«¯å¤„ç†æ¶ˆæ¯çš„è¿‡ç¨‹ã€‚</p><h3 id="å‰ç«¯å¦‚ä½•è¿æ¥åˆ°åç«¯çš„wså¹¶å¤„ç†json-rpcæ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#å‰ç«¯å¦‚ä½•è¿æ¥åˆ°åç«¯çš„wså¹¶å¤„ç†json-rpcæ¶ˆæ¯"><span>å‰ç«¯å¦‚ä½•è¿æ¥åˆ°åç«¯çš„WSå¹¶å¤„ç†json-rpcæ¶ˆæ¯</span></a></h3><h3 id="è°ƒç”¨è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#è°ƒç”¨è¿‡ç¨‹"><span>è°ƒç”¨è¿‡ç¨‹ï¼š</span></a></h3><p><img src="'+e+'" alt="å‰åç«¯è°ƒç”¨proxy-rpc.png"> é€šè¿‡JSON-RPCä»£ç†å¯ä»¥å®ç°åœ¨å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æœåŠ¡ç«¯æ–¹æ³•åŠæœåŠ¡ç«¯ç›´æ¥è°ƒç”¨å®¢æˆ·ç«¯æ–¹æ³•ã€‚ä¸‹é¢é€šè¿‡theiaä¸­çš„ä¸€æ®µä»£ç æ³¨é‡Šå³å¯å¯¹ç”¨æ³•æœ‰ä¸ªå¤§æ¦‚è®¤è¯†ã€‚</p><p><strong>proxy-factory.ts</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>\n<span class="line"> * Factory for JSON-RPC proxy objects.</span>\n<span class="line"> *</span>\n<span class="line"> * A JSON-RPC proxy exposes the programmatic interface of an object through</span>\n<span class="line"> * JSON-RPC.  This allows remote programs to call methods of this objects by</span>\n<span class="line"> * sending JSON-RPC requests.  This takes place over a bi-directional stream,</span>\n<span class="line"> * where both ends can expose an object and both can call methods each other&#39;s</span>\n<span class="line"> * exposed object.</span>\n<span class="line"> *</span>\n<span class="line"> * For example, assuming we have an object of the following type on one end:</span>\n<span class="line"> *</span>\n<span class="line"> *     class Foo <span class="token punctuation">{</span></span>\n<span class="line"> *         bar(baz: number): number <span class="token punctuation">{</span> return baz + 1 <span class="token punctuation">}</span></span>\n<span class="line"> *     <span class="token punctuation">}</span></span>\n<span class="line"> *</span>\n<span class="line"> * which we want to expose through a JSON-RPC interface.  We would do:</span>\n<span class="line"> *</span>\n<span class="line"> *     let target = new Foo()</span>\n<span class="line"> *     let factory = new JsonRpcProxyFactory&lt;Foo&gt;(&#39;/foo&#39;, target)</span>\n<span class="line"> *     factory.onConnection(connection)</span>\n<span class="line"> *</span>\n<span class="line"> * The party at the other end of the `connection`, in order to remotely call</span>\n<span class="line"> * methods on this object would do:</span>\n<span class="line"> *</span>\n<span class="line"> *     let factory = new JsonRpcProxyFactory&lt;Foo&gt;(&#39;/foo&#39;)</span>\n<span class="line"> *     factory.onConnection(connection)</span>\n<span class="line"> *     let proxy = factory.createProxy();</span>\n<span class="line"> *     let result = proxy.bar(42)</span>\n<span class="line"> *     // result is equal to 43</span>\n<span class="line"> *</span>\n<span class="line"> * One the wire, it would look like this:</span>\n<span class="line"> *</span>\n<span class="line"> *     --&gt; <span class="token punctuation">{</span>&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 0, &quot;method&quot;: &quot;bar&quot;, &quot;params&quot;: <span class="token punctuation">{</span>&quot;baz&quot;: 42<span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n<span class="line"> *     &lt;-- <span class="token punctuation">{</span>&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 0, &quot;result&quot;: 43<span class="token punctuation">}</span></span>\n<span class="line"> *</span>\n<span class="line"> * Note that in the code of the caller, we didn&#39;t pass a target object to</span>\n<span class="line"> * JsonRpcProxyFactory, because we don&#39;t want/need to expose an object.</span>\n<span class="line"> * If we had passed a target object, the other side could&#39;ve called methods on</span>\n<span class="line"> * it.</span>\n<span class="line"> *</span>\n<span class="line"> * <span class="token keyword">@param</span> &lt;T&gt; - The type of the object to expose to JSON-RPC.</span>\n<span class="line"> */</span></span>\n<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JsonRpcProxyFactory<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> object<span class="token operator">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ProxyHandler<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‚£ä¹ˆæ˜¯å…·ä½“æ˜¯å¦‚ä½•å®ç°è¿™ç§æ•ˆæœçš„å‘¢ï¼Ÿä¸‹é¢ç»“åˆç”¨æ³•ä¸€ç‚¹ä¸€ç‚¹æ¥çœ‹<code>JsonRpcProxyFactory</code>åˆ°åº•æ˜¯åšäº†ä»€ä¹ˆäº‹ã€‚å›åˆ°ä¸Šé¢ä½¿ç”¨çš„åœ°æ–¹ï¼Œå½“å‰ç«¯å‡†å¤‡ä¸æœåŠ¡ç«¯å»ºç«‹é“¾æ¥ï¼Œå‰ç«¯ä¸åç«¯å»ºç«‹è¿æ¥ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p><p><strong>å‰ç«¯</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token generic-function"><span class="token function">createProxy</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> object<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> arg<span class="token operator">?</span><span class="token operator">:</span> object<span class="token punctuation">)</span><span class="token operator">:</span> JsonRpcProxy<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">const</span> factory <span class="token operator">=</span> arg <span class="token keyword">instanceof</span> <span class="token class-name">JsonRpcProxyFactory</span> <span class="token operator">?</span> arg <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">JsonRpcProxyFactory<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>\n<span class="line">        path<span class="token punctuation">,</span></span>\n<span class="line">        <span class="token function-variable function">onConnection</span><span class="token operator">:</span> c <span class="token operator">=&gt;</span> factory<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>åç«¯</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// readonly factoryConstructor: new () =&gt; JsonRpcProxyFactory&lt;T&gt; = JsonRpcProxyFactory</span></span>\n<span class="line"><span class="token function">onConnection</span><span class="token punctuation">(</span>connection<span class="token operator">:</span> MessageConnection<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token keyword">this</span></span><span class="token punctuation">.</span><span class="token function">factoryConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">const</span> proxy <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    factory<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">targetFactory</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    factory<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä¸Šé¢çš„ä»£ç å‘ç°<code>JsonRpcProxyFactory</code>é€šè¿‡<code>createProxy</code>ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå¯ä»¥ç†è§£ä¸ºå‰åç«¯å¯¹è±¡çš„ä»£ç†ï¼Œé€šè¿‡æ“ä½œæ­¤ä»£ç†å¯ä»¥è¾¾åˆ°ä¸Šè¿°çš„æ•ˆæœï¼Œå…¶ä¸­è¢«ä»£ç†çš„å¯¹è±¡å°±æ˜¯<code>target</code>ã€‚</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JsonRpcProxyFactory<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> object<span class="token operator">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ProxyHandler<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line">\t<span class="token doc-comment comment">/**</span>\n<span class="line">     * Build a new JsonRpcProxyFactory.</span>\n<span class="line">     *</span>\n<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">target</span> - The object to expose to JSON-RPC methods calls.  If this</span>\n<span class="line">     *   is omitted, the proxy won&#39;t be able to handle requests, only send them.</span>\n<span class="line">     */</span></span>\n<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">public</span> target<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line">\t<span class="token doc-comment comment">/**</span>\n<span class="line">     * Connect a MessageConnection to the factory.</span>\n<span class="line">     *</span>\n<span class="line">     * This connection will be used to send/receive JSON-RPC requests and</span>\n<span class="line">     * response.</span>\n<span class="line">     */</span></span>\n<span class="line">    <span class="token function">listen</span><span class="token punctuation">(</span>connection<span class="token operator">:</span> MessageConnection<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>\n<span class="line">        connection<span class="token punctuation">.</span><span class="token function">onRequest</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onRequest</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        connection<span class="token punctuation">.</span><span class="token function">onNotification</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onNotification</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        connection<span class="token punctuation">.</span><span class="token function">onDispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        connection<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connectionPromiseResolve</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token doc-comment comment">/**</span>\n<span class="line">     * Process an incoming JSON-RPC method call.</span>\n<span class="line">     *</span>\n<span class="line">     * onRequest is called when the JSON-RPC connection received a method call</span>\n<span class="line">     * request.  It calls the corresponding method on [[target]].</span>\n<span class="line">     *</span>\n<span class="line">     * The return value is a Promise object that is resolved with the return</span>\n<span class="line">     * value of the method call, if it is successful.  The promise is rejected</span>\n<span class="line">     * if the called method does not exist or if it throws.</span>\n<span class="line">     *</span>\n<span class="line">     * <span class="token keyword">@returns</span> A promise of the method call completion.</span>\n<span class="line">     */</span></span>\n<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token function">onRequest</span><span class="token punctuation">(</span>method<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token comment">// ...</span></span>\n<span class="line">\t\t<span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token comment">// ...</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line">\t<span class="token doc-comment comment">/**</span>\n<span class="line">     * Create a Proxy exposing the interface of an object of type T.  This Proxy</span>\n<span class="line">     * can be used to do JSON-RPC method calls on the remote target object as</span>\n<span class="line">     * if it was local.</span>\n<span class="line">     *</span>\n<span class="line">     * If `T` implements `JsonRpcServer` then a client is used as a target object for a remote target object.</span>\n<span class="line">     */</span></span>\n<span class="line">    <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> JsonRpcProxy<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">return</span> result <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token function">get</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> p<span class="token operator">:</span> PropertyKey<span class="token punctuation">,</span> receiver<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token string">&#39;setClient&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">(</span>client<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> client<span class="token punctuation">;</span></span>\n<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token string">&#39;getClient&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">\t\t<span class="token comment">// ...</span></span>\n<span class="line">\t\t<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t<span class="token comment">// ...</span></span>\n<span class="line">\t\t\t<span class="token keyword">const</span> resultPromise <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">sendRequest</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t<span class="token comment">// ...</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å‰åç«¯å¦‚ä½•äº’ç›¸å‘é€æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#å‰åç«¯å¦‚ä½•äº’ç›¸å‘é€æ¶ˆæ¯"><span>å‰åç«¯å¦‚ä½•äº’ç›¸å‘é€æ¶ˆæ¯</span></a></h3><ul><li>å¯ç›´æ¥é€šè¿‡<code>channel.send(message)</code>å‘é€æ¶ˆæ¯</li><li>å¯é€šè¿‡ä»£ç†å¯¹è±¡çš„<code>get</code>æ–¹æ³•</li></ul><p>é€šè¿‡<code>channel.send</code>åœ¨ä¸Šé¢å·²ç»è¯´è¿‡äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹å¦‚ä½•ä½¿ç”¨ä»£ç†å¯¹è±¡å‘é€æ¶ˆæ¯ã€‚</p><p>æœ‰ä¸Šæ–‡åˆ›å»ºä»£ç†å¯¹è±¡çš„å·¥å‚å‡½æ•°å¯çŸ¥ï¼Œè¯»å–ä»£ç†å¯¹è±¡ä¸Šçš„å±æ€§ä¼šè§¦å‘å†…éƒ¨å£°æ˜çš„<code>get</code>æ–¹æ³•ï¼Œé€šè¿‡ä»£ç æˆ‘ä»¬å‘ç°ä¼šæ‰§è¡Œåˆ°ä¸‹é¢æ–¹æ³•ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> resultPromise <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">sendRequest</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å…¶ä¸­<code>sendRequest</code>æ–¹æ³•åœ¨<code>vscode-jsonrpc/lib/main.js</code>ä¸­ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><p><strong>vscode-jsonrpc/lib/main.js</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token function-variable function">sendRequest</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> <span class="token operator">...</span>params</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line">\tmessageWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>requestMessage<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token comment">// ...</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>vscode-ws-jsonrpc/src/socket/writer.ts</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">WebSocketMessageWriter</span> <span class="token keyword">extends</span> <span class="token class-name">messageWriter_1</span><span class="token punctuation">.</span>AbstractMessageWriter <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">protected</span> <span class="token keyword">readonly</span> socket<span class="token operator">:</span> IWebSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token comment">// ...</span></span>\n<span class="line">\t\t<span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token comment">// ...</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>vscode-ws-jsonrpc/src/socket/connection.ts</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createWebSocketConnection</span><span class="token punctuation">(</span>socket<span class="token operator">:</span> IWebSocket<span class="token punctuation">,</span> logger<span class="token operator">:</span> Logger<span class="token punctuation">)</span><span class="token operator">:</span> MessageConnection <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">const</span> messageReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketMessageReader</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">const</span> messageWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketMessageWriter</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token function">createMessageConnection</span><span class="token punctuation">(</span>messageReader<span class="token punctuation">,</span> messageWriter<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    connection<span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> connection<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">return</span> connection<span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>createWebSocketConnection</code>åˆ™æ˜¯åœ¨ä¸Šæ–‡ä¸­é€šè¿‡<code>channel</code>åˆ›å»º<code>connection</code>çš„å…³é”®æ–¹æ³•ã€‚ è¿™æ ·ï¼Œå½“å®¢æˆ·ç«¯è°ƒç”¨<code>getHgService.getName();</code>æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†ä»£ç†çš„getå‡½æ•°ï¼Œè¿›è€Œï¼Œæ‰§è¡Œäº†<code>const resultPromise = connection.sendRequest(method, ...args) as Promise&lt;any&gt;;</code>ä»è€Œå‘é€å‘æœåŠ¡ç«¯sendäº†ä¸€ä¸ªè¯·æ±‚ã€‚æœåŠ¡ç«¯ç”±äºåœ¨å»ºç«‹ç›‘å¬æ—¶ï¼Œä¸Šæ–‡ä»‹ç»è¿‡ï¼Œåœ¨JsonRpcProxyFactoryä¸­ï¼Œ<code>listen</code>æ–¹æ³•ç»‘å®šäº†ä¸€ç³»åˆ—å¯¹äºjson-rpcæ¶ˆæ¯çš„å¤„ç†å‡½æ•°ã€‚å½“æœåŠ¡ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œä¸Šæ–‡ä»£ç å†™åˆ°ï¼Œä¼šè§¦å‘<code>fireMessage</code>æ–¹æ³•ï¼Œä»è€Œï¼Œè§¦å‘äº†ä¸€å¼€å§‹ç»‘å®šçš„<code>readMessage</code>æ–¹æ³•ï¼Œä»è€Œå…³è”åˆ°äº†listenä¸­ç»‘å®šçš„ä¸€ç³»åˆ—callbackã€‚è¿›è€Œæ ¹æ®æ¶ˆæ¯ç±»å‹åˆ¤æ–­ä¸º<code>Request</code>ï¼Œåˆ™è§¦å‘äº†åœ¨<code>listen</code>æ—¶çš„onRequestç›‘å¬å‡½æ•°ï¼Œä»è€Œè§¦å‘äº†ä¸‹é¢çš„æ‰§è¡Œä»£ç ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token function">onRequest</span><span class="token punctuation">(</span>method<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">no target was set to handle </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">const</span> e <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">serializeError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ResponseError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token keyword">throw</span> e<span class="token punctuation">;</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token keyword">const</span> reason <span class="token operator">=</span> e<span class="token punctuation">.</span>message <span class="token operator">||</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">const</span> stack <span class="token operator">=</span> e<span class="token punctuation">.</span>stack <span class="token operator">||</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Request </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> failed with error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">throw</span> e<span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h3><p>æœ¬æ–‡ä¸»è¦æ˜¯åŸºäºTheiaåˆ©ç”¨vscode-json-rpcæ’ä»¶è¿›è¡Œå‰åç«¯çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æœºåˆ¶ï¼Œè®¾è®¡äº†ä¸€å¥—æœ¬åœ°çš„ç®€ç‰ˆå®ç°ã€‚é‚£ä¹ˆä»ä¸­æˆ‘ä»¬å¯ä»¥æ·±åˆ‡çš„ç†è§£å…³äºä»£ç†å·¥å‚ã€å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ã€json-rpcçš„è¯·æ±‚ç±»å‹ã€å…³äºæ•´ä¸ªè·¯ç”±è°ƒåº¦ã€ç›‘å¬å‡½æ•°çš„ç»‘å®šè¿‡ç¨‹çš„æŠ€æœ¯åº•å±‚è®¾è®¡ã€‚</p>',88)]))}]]),l=JSON.parse('{"path":"/AB%E4%BA%A7%E5%93%81%E7%9F%A5%E8%AF%86%E5%BA%93/%E7%9F%A5%E8%AF%86%E6%8E%A2%E7%B4%A2/%E5%89%8D%E7%AB%AF/Eclipse-Thiea/C%E7%AB%AF%E6%96%B0%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94%E7%AF%874%E2%80%94%E2%80%94%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E5%A5%97%E5%9F%BA%E4%BA%8Ejson-rpc%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E6%9C%BA%E5%88%B6%EF%BC%9F.html","title":"","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"ä»€ä¹ˆæ˜¯RPCï¼Ÿ","slug":"ä»€ä¹ˆæ˜¯rpc","link":"#ä»€ä¹ˆæ˜¯rpc","children":[]},{"level":2,"title":"json-rpcå…·ä½“æœ‰å“ªäº›åº”ç”¨åœºæ™¯ï¼Ÿ","slug":"json-rpcå…·ä½“æœ‰å“ªäº›åº”ç”¨åœºæ™¯","link":"#json-rpcå…·ä½“æœ‰å“ªäº›åº”ç”¨åœºæ™¯","children":[]},{"level":2,"title":"å…ˆæ‹¿ä¸€ä¸ªåœºæ™¯ä¸¾ä¾‹ğŸŒ°ï¼š","slug":"å…ˆæ‹¿ä¸€ä¸ªåœºæ™¯ä¸¾ä¾‹","link":"#å…ˆæ‹¿ä¸€ä¸ªåœºæ™¯ä¸¾ä¾‹","children":[]},{"level":2,"title":"æ•´ä½“æ¶æ„ï¼š","slug":"æ•´ä½“æ¶æ„","link":"#æ•´ä½“æ¶æ„","children":[{"level":3,"title":"å‰ç«¯å¦‚ä½•è¿æ¥åˆ°åç«¯çš„WSå¹¶å¤„ç†json-rpcæ¶ˆæ¯","slug":"å‰ç«¯å¦‚ä½•è¿æ¥åˆ°åç«¯çš„wså¹¶å¤„ç†json-rpcæ¶ˆæ¯","link":"#å‰ç«¯å¦‚ä½•è¿æ¥åˆ°åç«¯çš„wså¹¶å¤„ç†json-rpcæ¶ˆæ¯","children":[]},{"level":3,"title":"è°ƒç”¨è¿‡ç¨‹ï¼š","slug":"è°ƒç”¨è¿‡ç¨‹","link":"#è°ƒç”¨è¿‡ç¨‹","children":[]},{"level":3,"title":"å‰åç«¯å¦‚ä½•äº’ç›¸å‘é€æ¶ˆæ¯","slug":"å‰åç«¯å¦‚ä½•äº’ç›¸å‘é€æ¶ˆæ¯","link":"#å‰åç«¯å¦‚ä½•äº’ç›¸å‘é€æ¶ˆæ¯","children":[]},{"level":3,"title":"æ€»ç»“","slug":"æ€»ç»“","link":"#æ€»ç»“","children":[]}]}],"git":{"updatedTime":1727145923000,"contributors":[{"name":"wangaoqi","email":"wangaoqi@agree.com.cn","commits":1}]},"filePathRelative":"ABäº§å“çŸ¥è¯†åº“/çŸ¥è¯†æ¢ç´¢/å‰ç«¯/Eclipse-Thiea/Cç«¯æ–°æŠ€æœ¯è°ƒç ”ç¯‡4â€”â€”å¦‚ä½•è®¾è®¡ä¸€å¥—åŸºäºjson-rpcçš„å‰åç«¯è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æœºåˆ¶ï¼Ÿ.md"}')}}]);